# תיקון שגיאת מחיקת משימות

## תאריך
25 בינואר 2026

## בעיה שזוהתה
בעת מחיקת משימה, התגלו מספר בעיות:

1. **CSRF Token חסר**: השרת החזיר שגיאה 400 "The CSRF token is missing" כי ה-route לא היה פטור מ-CSRF, בעוד שהבקשה נשלחת מ-JavaScript ללא token.

2. **תלויות לא נוקו**: כאשר משימה נמחקה, משימות אחרות שהתייחסו אליה בתלויות (dependencies) נשארו עם הפניות שבורות למשימה שנמחקה.

3. **סשנים פעילים של מעקב זמן**: אם היה סשן פעיל של מעקב זמן למשימה שנמחקה, הוא נשאר פעיל גם אחרי המחיקה.

4. **טיפול בשגיאות בצד הלקוח**: הקוד בצד הלקוח לא בדק את `response.data.success` לפני הצגת הודעת הצלחה, מה שגרם לכך שגם כשהמחיקה נכשלה, לא הוצגה שגיאה.

## פתרון
תוקנה הפונקציה `delete_task` בקובץ `app.py` כך שתבצע:

1. **הוספת פטור מ-CSRF**: נוסף `@csrf.exempt` ל-route כדי לאפשר קריאות מ-JavaScript ללא CSRF token.

2. **ניקוי תלויות**: לפני מחיקת המשימה, הפונקציה מסירה את ה-ID של המשימה מרשימת התלויות של כל המשימות האחרות באותו פרויקט.

3. **ביטול סשנים פעילים**: הפונקציה בודקת אם יש סשנים פעילים של מעקב זמן למשימה שנמחקת ומבטלת אותם.

4. **שיפור טיפול בשגיאות**: נוספה לוגיקה טובה יותר לטיפול בשגיאות והודעות שגיאה ברורות יותר.

5. **שיפור בצד הלקוח**: 
   - החלפת `confirm()` ב-Dialog component של React
   - בדיקת `response.data.success` לפני הצגת הודעת הצלחה
   - הצגת שגיאות גם כאשר השרת מחזיר 200 עם `success: false`

## שינויים בקוד

### קובץ: `app.py`
- **פונקציה**: `delete_task` (שורות 2363-2433)
- **שינויים**:
  - הוספת `@csrf.exempt` ל-route
  - הוספת לוגיקה לניקוי תלויות ממשימות אחרות
  - הוספת לוגיקה לביטול סשנים פעילים של מעקב זמן
  - שיפור הודעות שגיאה והודעות הצלחה
  - הוספת לוגים לניפוי באגים

### קובץ: `src/pages/ClientPage.tsx`
- **פונקציה**: `handleDeleteTask` (שורות 466-475)
- **פונקציה**: `confirmDeleteTask` (שורות 477-570)
- **שינויים**:
  - החלפת `confirm()` ב-Dialog component של React
  - הוספת state לניהול Dialog לאישור מחיקה
  - בדיקת `response.data.success` לפני הצגת הודעת הצלחה
  - הצגת שגיאות גם כאשר השרת מחזיר 200 עם `success: false`

## בדיקות מומלצות
1. למחוק משימה שיש לה תלויות - לוודא שהתלויות נוקו ממשימות אחרות
2. למחוק משימה שיש לה סשן פעיל של מעקב זמן - לוודא שהסשן בוטל
3. למחוק משימה רגילה - לוודא שהמחיקה עובדת כרגיל

## הערות
- רשומות היסטוריות של מעקב זמן נשארות עם הפניה למשימה שנמחקה (זה תקין לשמירת היסטוריה)
- התיקון שומר על תאימות לאחור ולא משנה את מבנה הנתונים
