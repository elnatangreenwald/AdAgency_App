<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{{ client.name }} | ×•×ª×§×™×Ÿ ×‘×•×˜×™×§</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='common_styles.css') }}">
    <script src="{{ url_for('static', filename='global.js') }}"></script>
    <style>
        /* ×¢×“×›×•×Ÿ ×¡×’× ×•× ×•×ª ×¡×¤×¦×™×¤×™×™× ×œ×“×£ ×”×œ×§×•×— - Morning-inspired */
        
        body { 
            background: var(--bg-warm-gray); /* ×¨×§×¢ ××¤×•×¨ ×—× */
        }
        
        .main-content { 
            padding: 40px; 
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .client-header-card { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: var(--bg-white); 
            padding: 30px; 
            border-radius: 16px; /* ×¤×™× ×•×ª ××¢×•×’×œ×•×ª */
            border: none;
            margin-bottom: 30px; 
            box-shadow: var(--shadow-md); /* ×¦×œ×œ×™×ª ×¨×›×” */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: visible;
        }
        
        /* ×¡×•×•×™×¦'×¨ ×œ×§×•×— ×¤×¢×™×œ */
        .client-active-toggle {
            display: flex !important;
            align-items: center;
            gap: 12px;
            position: absolute;
            left: 30px;
            top: 30px;
            z-index: 100;
            background: white;
            padding: 8px 12px;
            border-radius: 8px;
        }
        
        .client-active-toggle-label {
            font-family: 'Heebo', sans-serif;
            font-weight: 400;
            font-size: 0.95rem;
            color: #043841;
            margin: 0;
        }
        
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            cursor: pointer;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            border-radius: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background-color: #14a675;
        }
        
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        .toggle-switch input:focus + .toggle-slider {
            box-shadow: 0 0 0 3px rgba(20, 166, 117, 0.1);
        }
        
        .client-header-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient-primary); /* ×˜×•×¨×§×™×– */
            z-index: 1;
        }
        
        .client-header-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .client-logo-box { 
            width: 120px; 
            height: 120px; 
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 16px; 
            border: 2px dashed #cbd5e1; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden; 
            cursor: pointer; 
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .client-logo-box:hover {
            transform: scale(1.05);
            border-color: var(--primary);
            box-shadow: 0 8px 16px rgba(0,115,234,0.2);
        }
        
        #logoContainer {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 14px;
        }
        
        .client-logo-box img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover;
            transition: transform 0.3s;
            border-radius: 14px;
        }
        
        .client-logo-box:hover img {
            transform: scale(1.1);
        }
        
        .upload-overlay { 
            position: absolute; 
            bottom: 0; 
            width: 100%; 
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            color: white; 
            font-size: 11px; 
            text-align: center; 
            padding: 8px 0; 
            opacity: 0; 
            transition: opacity 0.3s;
        }
        
        .client-logo-box:hover .upload-overlay { opacity: 1; }
        
        .project-card-new { 
            background: white; 
            padding: 25px; 
            border-radius: 16px; 
            margin-bottom: 20px; 
            border: none;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .project-card-new::before {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            background: var(--gradient-primary);
            transform: scaleY(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .project-card-new:hover {
            transform: translateX(-5px);
            box-shadow: var(--shadow-md);
        }
        
        .project-card-new:hover::before {
            transform: scaleY(1);
        }
        
        /* ×ª××•× ×•×ª ×‘××©×™××•×ª */
        .tasks-list img,
        .task-row img,
        .task-card img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 12px;
            object-fit: contain;
            display: block;
            margin: 5px 0;
            box-sizing: border-box;
            background: rgba(0, 0, 0, 0.03);
            padding: 4px;
        }
        
        .task-row {
            flex-wrap: wrap;
            overflow: hidden;
        }
        
        .task-card { 
            background: var(--bg-white); 
            padding: 18px; 
            border-radius: 16px; /* ×¤×™× ×•×ª ××¢×•×’×œ×•×ª */
            margin-bottom: 12px; 
            border: 1px solid #e6e9ef; 
            display: flex; 
            flex-direction: column; 
            gap: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: var(--shadow-sm); /* ×¦×œ×œ×™×ª ×¢×“×™× ×” */
            overflow: hidden;
        }
        
        /* ×ª××•× ×•×ª ×‘××©×™××•×ª */
        .tasks-list img,
        .task-row img,
        .task-card img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 12px;
            object-fit: contain;
            display: block;
            margin: 5px 0;
            box-sizing: border-box;
            background: rgba(0, 0, 0, 0.03);
            padding: 4px;
        }
        
        .task-row {
            flex-wrap: wrap;
            overflow: hidden;
        }
        
        .task-card::before {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--primary); /* ×˜×•×¨×§×™×– */
            border-radius: 0 16px 16px 0;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .task-card:hover {
            transform: translateX(-5px);
            box-shadow: var(--shadow-md); /* ×¦×œ×œ×™×ª ×¨×›×” ×™×•×ª×¨ */
            border-color: #cbd5e1;
        }
        
        .task-card:hover::before {
            opacity: 1;
        }
        
        .task-status-select { 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
            font-family: 'Heebo', sans-serif;
            font-weight: 700; /* ×¢×‘×•×ª */
            font-size: 0.95rem;
            background: white;
            color: #043841;
            border-radius: 12px; /* ×¤×™× ×•×ª ××¢×•×’×œ×•×ª */
        }
        
        .task-status-select:hover { 
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }
        
        .task-status-select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(61, 129, 122, 0.1); /* ×¦×œ×œ×™×ª ×˜×•×¨×§×™×– */
        }
        
        /* ×‘×•×¢×•×ª ×¦×‘×¢×•× ×™×•×ª ×œ×¡×˜×˜×•×¡×™× - Morning style */
        .task-status-select[data-status="×œ×‘×™×¦×•×¢"] {
            background: #bfc9f2;
            color: #043841;
            border-color: rgba(191, 201, 242, 0.5);
        }
        
        .task-status-select[data-status="×”×•×¢×‘×¨ ×œ×¡×˜×•×“×™×•"] {
            background: #2b585e;
            color: white;
            border-color: rgba(43, 88, 94, 0.5);
        }
        
        .task-status-select[data-status="×”×•×¢×‘×¨ ×œ×“×™×’×™×˜×œ"] {
            background: #043841;
            color: white;
            border-color: rgba(4, 56, 65, 0.5);
        }
        
        .task-status-select[data-status="× ×©×œ×— ×œ×œ×§×•×—"] {
            background: #b8e994;
            color: #2d3748;
            border-color: rgba(184, 233, 148, 0.5);
        }
        
        .task-status-select[data-status="×”×•×©×œ×"] {
            background: #14a675;
            color: white;
            border-color: rgba(20, 166, 117, 0.5);
        }
        
        /* ××•×¤×¦×™×•×ª ×‘-select - ×›×•×œ×Ÿ ×œ×‘×Ÿ ×¢× ×˜×§×¡×˜ #043841 */
        .task-status-select option {
            padding: 10px;
            font-family: 'Heebo', sans-serif;
            font-weight: 600;
            background: white;
            color: #043841;
        }
        
        /* ×›×¤×ª×•×¨×™ ×”×•×¡×¤×” - ×œ×™×™× ×‘×”×™×¨ */
        .btn-add-project, .btn-add-task, button[type="submit"]:not(.btn-danger):not(.btn-black) {
            background: var(--accent-lime); /* ×œ×™×™× ×‘×”×™×¨ */
            color: #2d3748; /* ×˜×§×¡×˜ ×›×”×” */
            border: none; 
            padding: 12px 24px; 
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: 700; 
            text-decoration: none; 
            display: inline-block;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
            font-family: 'Heebo', sans-serif;
        }
        
        .btn-add-project:hover, .btn-add-task:hover, button[type="submit"]:not(.btn-danger):not(.btn-black):hover {
            background: #9dd465; /* ×œ×™×™× ×›×”×” ×™×•×ª×¨ */
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-success { 
            background: var(--money);
        }
        
        .btn-success:hover {
            background: #00a86b;
        }
        
        .btn-black { 
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
        }
        
        .btn-black:hover {
            transform: translateY(-2px);
        
            box-shadow: var(--shadow-md);
        }
        
        .btn-small { 
            padding: 6px 12px; 
            font-size: 0.85rem; 
        }
        
        input, select, textarea { 
            padding: 10px 14px; 
            border: 2px solid #e6e9ef; 
            border-radius: 8px; 
            font-family: 'Heebo', sans-serif;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0,115,234,0.1);
        }
        
        .user-badge { 
            background: linear-gradient(135deg, #e1e6ff 0%, #c7d2fe 100%);
            color: var(--primary); 
            padding: 6px 16px; 
            border-radius: 20px; 
            font-size: 0.85rem; 
            font-weight: bold; 
            display: inline-block; 
            margin-top: 8px;
            box-shadow: var(--shadow-sm);
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            background: white; 
            border-radius: 12px; 
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        
        th, td { 
            padding: 14px; 
            text-align: right; 
            border-bottom: 1px solid #e6e9ef; 
            transition: background 0.2s;
        }
        
        th { 
            background: #043841; /* ×¦×‘×¢ ××—×™×“ ×œ×¨××©×™ ×˜×‘×œ××•×ª */
            color: white; 
            font-weight: 700;
        }
        
        tr:hover td {
            background: #f8fafc;
        }
        
        /* Projects Section */
        .projects-section {
            background: white;
            padding: 35px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: none;
            box-shadow: var(--shadow-md);
            animation: slideInUp 0.5s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Finance Section */
        .finance-section {
            background: white;
            padding: 30px;
            border-radius: 20px;
            border-top: 5px solid var(--money);
            margin-bottom: 30px;
            box-shadow: var(--shadow-md);
            animation: slideInUp 0.6s ease-out;
        }
        
        /* Documents Section */
        .documents-section {
            background: white;
            padding: 30px;
            border-radius: 20px;
            border: none;
            box-shadow: var(--shadow-md);
            animation: slideInUp 0.7s ease-out;
        }
        
        /* Smooth animations for dynamic content */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .task-card[data-task-id],
        .project-card-new[data-project-id] {
            animation: slideIn 0.4s ease-out;
        }
        
        /* Project Collapse/Expand */
        .project-card-new {
            position: relative;
        }
        
        .project-header {
            cursor: pointer;
            user-select: none;
        }
        
        .project-toggle-icon {
            display: inline-block;
            transition: transform 0.3s ease;
            margin-left: 8px;
            color: #64748b;
        }
        
        .project-card-new.collapsed .project-toggle-icon {
            transform: rotate(-90deg);
        }
        
        .project-card-new .tasks-list,
        .project-card-new .add-task-form {
            display: block;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .project-card-new.collapsed .tasks-list,
        .project-card-new.collapsed .add-task-form {
            display: none;
        }
        
        /* Loading state */
        .ajax-loader {
            backdrop-filter: blur(2px);
        }
        
        /* Smooth transitions for all interactive elements */
        button, a, input, select {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Add task form styling */
        .add-task-form {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            padding: 20px;
            border-radius: 12px;
            border: 2px dashed #cbd5e1;
            transition: all 0.3s;
        }
        
        .add-task-form:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, #f0f4ff 0%, #ffffff 100%);
        }
        
        /* Empty state styling */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #94a3b8;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border-radius: 16px;
            border: 2px dashed #cbd5e1;
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
    </style>
</head>
<body data-client-id="{{ client.id }}">
    <div class="sidebar">
        <a href="/" class="sidebar-logo"><img src="{{ url_for('static', filename='Vatkin_Logo.jpg') }}"></a>
        <a href="/" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            ×“×©×‘×•×¨×“
        </a>
        <div class="nav-item">
            <a href="/all_clients" class="nav-link">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                ×œ×•×— ×œ×§×•×—×•×ª
            </a>
            <div class="users-dropdown">
                {% for uid, info in sidebar_users.items() %}
                <a href="/all_clients?user={{ uid }}" class="user-sub-link">â€¢ {{ info.name }}</a>
                {% endfor %}
            </div>
        </div>
        <a href="/finance" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
            ×›×¡×¤×™×
        </a>
        <a href="/events" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            ××™×¨×•×¢×™×
        </a>
        <a href="/suppliers" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
            ×¡×¤×§×™×
        </a>
        <a href="/quotes" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
            ×”×¦×¢×•×ª ××—×™×¨
        </a>
        <a href="/forms" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
            ×˜×¤×¡×™×
        </a>
        <a href="/admin/dashboard" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
            ×“×•×— ×× ×”×œ×™×
        </a>
        {% if current_user.id == 'admin' or user_role in ['×× ×”×œ', '××“××™×Ÿ'] %}
        {% if current_user.id == 'admin' %}
        <a href="/admin/users" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"></path></svg>
            × ×™×”×•×œ ×¦×•×•×ª
        </a>
        {% endif %}
        <a href="/archive" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 24 24"><polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line></svg>
            ××¨×›×™×•×Ÿ
        </a>
        {% endif %}
        <div class="sidebar-user-area">
            <div class="sidebar-user-name">{{ current_user.name }}</div>
            <a href="/logout" class="sidebar-logout-link">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                ×”×ª× ×ª×§
            </a>
        </div>
    </div>

    <div class="main-content">
        <div class="client-header-card">
            {% if current_user.id == 'admin' or user_role in ['×× ×”×œ', '××“××™×Ÿ'] %}
            <div class="client-active-toggle">
                <label class="toggle-switch">
                    <input type="checkbox" id="clientActiveToggle" {% if not client.get('archived', False) %}checked{% endif %} onchange="toggleClientActive(this)">
                    <span class="toggle-slider"></span>
                </label>
                <span class="client-active-toggle-label">×œ×§×•×— ×¤×¢×™×œ</span>
            </div>
            {% endif %}
            <div style="display:flex; align-items:center; gap:20px;">
                <form action="/upload_logo/{{ client.id }}" method="POST" enctype="multipart/form-data" style="display: inline-block;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="client-logo-box" onclick="document.getElementById('logoInput').click();" style="cursor: pointer;">
                        <div id="logoContainer">
                            {% if client.get('logo_url') %}
                            <img src="/static/logos/{{ client.get('logo_url')|e }}?v={{ logo_cache_bust }}" id="logoImage" onerror="console.error('Failed to load logo:', this.src); this.style.display='none';">
                            {% else %}
                            <span style="color: #94a3b8; font-size: 0.7rem;">×œ×—×¥ ×œ×”×¢×œ××”</span>
                            {% endif %}
                        </div>
                        <div class="upload-overlay">×”×—×œ×£ ×œ×•×’×•</div>
                    </div>
                    <input type="file" id="logoInput" name="logo" accept="image/*" style="display:none;" onchange="console.log('File selected'); this.form.submit();">
                </form>
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 15px; justify-content: space-between;">
                        <h1 style="margin:0; flex: 1;">{{ client.name }}</h1>
                    </div>
                    <div style="font-size: 0.9rem; color: #64748b; margin-top: 5px; font-weight: 400;">××¡×¤×¨ ×œ×§×•×—: {{ client.get('client_number', 'N/A') }}</div>
                    <div class="user-badge">ğŸ‘¤ ×× ×”×œ: {{ assigned_name }}</div>
                </div>
            </div>
        </div>

        <!-- Projects and Tasks Section -->
        <div class="projects-section" style="background: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #e6e9ef;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h3 style="margin: 0; color: #292f4c; font-size: 1.3rem; font-weight: bold;">×¤×¨×•×™×§×˜×™× ×•××©×™××•×ª</h3>
                <form onsubmit="event.preventDefault(); ProjectManager.add('{{ client.id }}', this);" style="display: flex; gap: 12px; align-items: center;">
                    <input type="text" name="title" placeholder="×©× ×¤×¨×•×™×§×˜ ×—×“×©..." style="padding: 12px 16px; border: 2px solid #e6e9ef; border-radius: 10px; min-width: 250px; font-size: 0.95rem;" required>
                    <select name="is_shared" style="padding: 12px 16px; border: 2px solid #e6e9ef; border-radius: 10px; font-size: 0.95rem; min-width: 150px;">
                        <option value="false">×¤×¨×˜×™</option>
                        <option value="true">××©×•×ª×£</option>
                    </select>
                    <button type="submit" class="btn-add-project" style="white-space: nowrap;">+ ×”×•×¡×£ ×¤×¨×•×™×§×˜</button>
                </form>
            </div>
            
            {% for project in client.get('projects', []) %}
            <div class="project-card-new collapsed" data-project-id="{{ project.id }}" style="background: #f8fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #e6e9ef;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 12px; flex: 1;" class="project-header" onclick="toggleProject(this.closest('.project-card-new'))">
                        <h4 style="margin: 0; color: var(--primary); font-size: 1.2rem; display: flex; align-items: center;">
                            <svg class="project-toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                            {{ project.title }}
                            {% if project.get('project_number') %}
                            <span style="color: #94a3b8; font-size: 0.75rem; font-weight: normal; margin-right: 8px; font-family: 'Heebo', monospace;">#{{ project.project_number }}</span>
                            {% endif %}
                        </h4>
                        <a href="/project/{{ client.id }}/{{ project.id }}/gantt" class="btn-black" style="padding: 6px 12px; font-size: 0.85rem; text-decoration: none; white-space: nowrap;" onclick="event.stopPropagation();">×ª×¨×©×™× ×’×× ×˜</a>
                    </div>
                    <button onclick="ProjectManager.delete('{{ client.id }}', '{{ project.id }}')" class="btn btn-danger btn-small" style="box-shadow: none; display: flex; align-items: center; gap: 6px; background: white; border: 1px solid #e6e9ef; color: #043841;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#043841" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        ××—×§ ×¤×¨×•×™×§×˜
                    </button>
                </div>
                
                <!-- Tasks List -->
                <div class="tasks-list" style="margin-bottom: 15px;">
                    {% for task in project.get('tasks', []) %}
                    {% set task_deadline = task.get('deadline', '') %}
                    {% set task_priority = task.get('priority', 'medium') %}
                    {% set priority_colors = {'low': '#94a3b8', 'medium': '#3d817a', 'high': '#f59e0b', 'urgent': '#ef4444'} %}
                    {% set priority_texts = {'low': '× ××•×›×”', 'medium': '×‘×™× ×•× ×™×ª', 'high': '×’×‘×•×”×”', 'urgent': '×“×—×•×£'} %}
                    {% set deadline_display = '' %}
                    {% if task_deadline %}
                        {% if 'T' in task_deadline %}
                            {% set deadline_display = task_deadline.split('T')[0] %}
                        {% else %}
                            {% set deadline_display = task_deadline[:10] %}
                        {% endif %}
                    {% endif %}
                    <div class="task-row" data-task-id="{{ task.id }}" data-deadline="{{ task_deadline }}" data-priority="{{ task_priority }}" style="background: white; padding: 12px 18px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e6e9ef; border-left: 4px solid {{ priority_colors.get(task_priority, '#3d817a') }}; display: flex; align-items: center; gap: 15px; transition: all 0.3s; flex-wrap: wrap; overflow: hidden;">
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                <div style="font-weight: bold; color: #292f4c; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    {{ task.title }}
                                </div>
                                {% if task_priority in ['high', 'urgent'] %}
                                <span style="background: {{ priority_colors.get(task_priority, '#3d817a') }}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold;">{{ priority_texts.get(task_priority, '') }}</span>
                                {% endif %}
                                {% if deadline_display %}
                                <input type="date" 
                                       class="task-deadline-input" 
                                       data-client-id="{{ client.id }}" 
                                       data-project-id="{{ project.id }}" 
                                       data-task-id="{{ task.id }}"
                                       value="{{ deadline_display }}"
                                       onchange="TaskManager.updateDeadline(this)"
                                       style="font-size: 0.75rem; font-weight: bold; padding: 4px 8px; border-radius: 8px; border: 1px solid #3d817a; background: #3d817a; color: white; cursor: pointer; font-family: 'Heebo', sans-serif; direction: ltr; text-align: right; min-width: 120px;">
                                {% else %}
                                <input type="date" 
                                       class="task-deadline-input" 
                                       data-client-id="{{ client.id }}" 
                                       data-project-id="{{ project.id }}"
                                       data-task-id="{{ task.id }}"
                                       placeholder="×”×•×¡×£ ×ª××¨×™×š"
                                       onchange="TaskManager.updateDeadline(this)"
                                       style="font-size: 0.75rem; font-weight: bold; padding: 4px 8px; border-radius: 8px; border: 1px dashed #cbd5e1; background: #f8fafc; color: #64748b; cursor: pointer; font-family: 'Heebo', sans-serif; direction: ltr; text-align: right; min-width: 120px;">
                                {% endif %}
                            </div>
                        </div>
                        {% set task_status = task.get('status', '×œ×‘×™×¦×•×¢') %}
                        <select class="task-status-select" data-status="{{ task_status }}" data-client-id="{{ client.id }}" data-project-id="{{ project.id }}" data-task-id="{{ task.id }}" onchange="TaskManager.updateStatusFromSelect(this)" style="padding: 8px 16px; border-radius: 8px; min-width: 180px; font-weight: 600;">
                            <option value="×œ×‘×™×¦×•×¢" {% if task_status == '×œ×‘×™×¦×•×¢' %}selected{% endif %}>×œ×‘×™×¦×•×¢</option>
                            <option value="×”×•×¢×‘×¨ ×œ×¡×˜×•×“×™×•" {% if task_status == '×”×•×¢×‘×¨ ×œ×¡×˜×•×“×™×•' %}selected{% endif %}>×”×•×¢×‘×¨ ×œ×¡×˜×•×“×™×•</option>
                            <option value="×”×•×¢×‘×¨ ×œ×“×™×’×™×˜×œ" {% if task_status == '×”×•×¢×‘×¨ ×œ×“×™×’×™×˜×œ' %}selected{% endif %}>×”×•×¢×‘×¨ ×œ×“×™×’×™×˜×œ</option>
                            <option value="× ×©×œ×— ×œ×œ×§×•×—" {% if task_status == '× ×©×œ×— ×œ×œ×§×•×—' %}selected{% endif %}>× ×©×œ×— ×œ×œ×§×•×—</option>
                            <option value="×”×•×©×œ×" {% if task_status == '×”×•×©×œ×' %}selected{% endif %}>×”×•×©×œ×</option>
                        </select>
                        <span style="color: #666; font-size: 0.85rem; white-space: nowrap; min-width: 100px; display: flex; align-items: center; gap: 6px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#043841" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block;">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            {{ task.get('created_date', '×œ×œ× ×ª××¨×™×š') }}
                        </span>
                        {% if task.get('note') %}
                        <span class="note-trigger" data-client-id="{{ client.id }}" data-project-id="{{ project.id }}" data-task-id="{{ task.id }}" data-note="{{ task.get('note', '')|replace('"', '&quot;')|replace("'", "&#39;") }}" style="color: #043841; font-size: 0.85rem; cursor: pointer; white-space: nowrap; padding: 2px 0; display: flex; align-items: center; gap: 6px;" title="×œ×—×¥ ×œ×¢×¨×™×›×”">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#043841" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; background: white; padding: 2px; border-radius: 4px;">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                            ×“×’×©×™×
                        </span>
                        {% else %}
                        <span class="note-trigger" data-client-id="{{ client.id }}" data-project-id="{{ project.id }}" data-task-id="{{ task.id }}" data-note="" style="color: #043841; font-size: 0.85rem; cursor: pointer; white-space: nowrap; padding: 2px 0; display: flex; align-items: center; gap: 6px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#043841" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; background: white; padding: 2px; border-radius: 4px;">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            ×“×’×©×™×
                        </span>
                        {% endif %}
                        <button onclick="TaskManager.delete('{{ client.id }}', '{{ project.id }}', '{{ task.id }}', this)" style="background: white; border: 1px solid #e6e9ef; padding: 6px 10px; border-radius: 5px; cursor: pointer; font-size: 0.85rem; white-space: nowrap; display: flex; align-items: center; justify-content: center; box-shadow: none;" title="××—×§">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#043841" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Add Task Form -->
                <form onsubmit="event.preventDefault(); TaskManager.add('{{ client.id }}', '{{ project.id }}', this);" class="add-task-form" style="background: white; padding: 15px; border-radius: 8px; border: 1px dashed #cbd5e1;">
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 10px; align-items: end;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #666; font-size: 0.85rem;">×©× ×”××©×™××”:</label>
                            <input type="text" name="title" placeholder="×©× ×”××©×™××”..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;" required>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #666; font-size: 0.85rem;">×¡×˜××˜×•×¡:</label>
                            <select name="status" class="task-status-select" style="width: 100%; padding: 8px 16px; border-radius: 8px; font-weight: 600;">
                                <option value="×œ×‘×™×¦×•×¢">×œ×‘×™×¦×•×¢</option>
                                <option value="×”×•×¢×‘×¨ ×œ×¡×˜×•×“×™×•">×”×•×¢×‘×¨ ×œ×¡×˜×•×“×™×•</option>
                                <option value="×”×•×¢×‘×¨ ×œ×“×™×’×™×˜×œ">×”×•×¢×‘×¨ ×œ×“×™×’×™×˜×œ</option>
                                <option value="× ×©×œ×— ×œ×œ×§×•×—">× ×©×œ×— ×œ×œ×§×•×—</option>
                                <option value="×”×•×©×œ×">×”×•×©×œ×</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #666; font-size: 0.85rem;">×¢×“×™×¤×•×ª:</label>
                            <select name="priority" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-family: 'Heebo', sans-serif;">
                                <option value="low">× ××•×›×”</option>
                                <option value="medium" selected>×‘×™× ×•× ×™×ª</option>
                                <option value="high">×’×‘×•×”×”</option>
                                <option value="urgent">×“×—×•×£</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #666; font-size: 0.85rem;">×ª××¨×™×š ×™×¢×“:</label>
                            <input type="date" name="deadline" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-family: 'Heebo', sans-serif;">
                        </div>
                        <div>
                            <button type="submit" class="btn-add-task" style="width: 100%; padding: 12px;">×”×•×¡×£ ××©×™××”</button>
                            <button type="button" onclick="TaskManager.showAdvancedForm(this)" class="btn-black" style="width: 100%; padding: 8px; margin-top: 5px; font-size: 0.85rem;">×¤×¨×˜×™× × ×•×¡×¤×™×</button>
                        </div>
                    </div>
                    <!-- Advanced fields (hidden by default) -->
                    <div class="task-advanced-fields" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e6e9ef;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #666; font-size: 0.85rem;">××—×¨××™:</label>
                                <select name="assignee" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-family: 'Heebo', sans-serif;">
                                    <option value="">×‘×—×¨ ××—×¨××™</option>
                                    {% for uid, user_info in sidebar_users.items() %}
                                    <option value="{{ uid }}" {% if uid == current_user.id %}selected{% endif %}>{{ user_info.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #666; font-size: 0.85rem;">×ª××¨×™×š ×œ×‘×™×¦×•×¢ (Deadline):</label>
                                <input type="date" name="deadline" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-family: 'Heebo', sans-serif; direction: ltr; text-align: right;">
                                <small style="color: #94a3b8; font-size: 0.7rem;">×™×§×‘×¢ ××ª ××™×§×•× ×”××©×™××” ×‘×œ×•×— ×”×©× ×”</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #666; font-size: 0.85rem;">×©×¢×•×ª ××©×•×¢×¨×•×ª:</label>
                                <input type="number" name="estimated_hours" placeholder="×©×¢×•×ª" step="0.5" min="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-family: 'Heebo', sans-serif;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #666; font-size: 0.85rem;">×ª×œ×•×™×•×ª:</label>
                                <select name="dependencies" multiple class="task-dependencies-select" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-family: 'Heebo', sans-serif; min-height: 80px;">
                                    {% for existing_task in project.get('tasks', []) %}
                                    <option value="{{ existing_task.id }}">{{ existing_task.title }}</option>
                                    {% endfor %}
                                </select>
                                <small style="color: #94a3b8; font-size: 0.75rem;">×œ×—×™×¦×” ××¨×•×‘×ª - ××©×™××•×ª ×©×¦×¨×™×›×•×ª ×œ×”×¡×ª×™×™× ×§×•×“×</small>
                            </div>
                        </div>
                        <div style="margin-top: 10px;">
                            <label style="display: block; margin-bottom: 5px; color: #666; font-size: 0.85rem;">×”×¢×¨×”:</label>
                            <textarea name="note" placeholder="×”×¢×¨×” (××•×¤×¦×™×•× ×œ×™)" rows="2" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-family: 'Heebo', sans-serif; resize: vertical;"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            {% endfor %}
            
            {% if not client.get('projects', []) %}
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“</div>
                <div style="font-weight: bold; margin-bottom: 5px; font-size: 1.1rem; color: #64748b;">××™×Ÿ ×¤×¨×•×™×§×˜×™× ×¢×“×™×™×Ÿ</div>
                <div style="font-size: 0.95rem; color: #94a3b8;">×”×•×¡×£ ×¤×¨×•×™×§×˜ ×¨××©×•×Ÿ ×‘×××¦×¢×•×ª ×”×˜×•×¤×¡ ×œ××¢×œ×”</div>
            </div>
            {% endif %}
        </div>
        
        <!-- Finance Section -->
        <div class="finance-section">
            <h3>×›×¡×¤×™×</h3>
            <form action="/update_finance/{{ client.id }}" method="POST" style="margin-bottom: 25px; padding: 20px; background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%); border-radius: 12px; border: 2px solid #e6e9ef;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" name="action" value="retainer">
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <label style="font-weight: bold; color: #292f4c; font-size: 1rem;">×¨×™×˜×™×™× ×¨:</label>
                    <input type="number" name="amount" value="{{ client.get('retainer', 0) }}" style="width: 120px; padding: 10px 14px; border: 2px solid #e6e9ef; border-radius: 8px; font-size: 1rem; font-weight: bold;">
                    <button type="submit" class="btn-black">×¢×“×›×Ÿ</button>
                </div>
            </form>
            <form action="/update_finance/{{ client.id }}" method="POST" class="add-task-form" style="margin-bottom: 25px;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" name="action" value="extra">
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 12px; align-items: end;">
                    <div>
                        <label style="display: block; margin-bottom: 6px; color: #64748b; font-size: 0.9rem; font-weight: bold;">×ª×™××•×¨ ×—×™×•×‘:</label>
                        <input type="text" name="title" placeholder="×ª×™××•×¨ ×—×™×•×‘" required style="width: 100%; padding: 12px 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; color: #64748b; font-size: 0.9rem; font-weight: bold;">×¡×›×•× ×œ×—×™×•×‘:</label>
                        <input type="number" name="amount" placeholder="×¡×›×•×" required style="width: 100%; padding: 12px 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; color: #64748b; font-size: 0.9rem; font-weight: bold;">×¢×œ×•×ª ×¤× ×™××™×ª (××•×¤×¦×™×•× ×œ×™):</label>
                        <input type="number" name="our_cost" placeholder="×¢×œ×•×ª ×¤× ×™××™×ª" step="0.01" style="width: 100%; padding: 12px 14px;">
                    </div>
                    <div>
                        <button type="submit" class="btn-black" style="white-space: nowrap; padding: 12px 20px;">×”×•×¡×£ ×—×™×•×‘</button>
                    </div>
                </div>
            </form>
            
            <!-- Charges Table -->
            {% set charges = client.get('extra_charges', []) %}
            {% if charges and charges|length > 0 %}
            <div style="margin-top: 20px;">
                <h4 style="margin-bottom: 15px; color: #292f4c;">×¨×©×™××ª ×—×™×•×‘×™×</h4>
                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                    <thead>
                        <tr>
                            <th>×ª×™××•×¨</th>
                            <th style="text-align: center;">×¡×›×•× ×œ×—×™×•×‘</th>
                            <th style="text-align: center;">×¢×œ×•×ª ×¤× ×™××™×ª</th>
                            <th style="text-align: center;">×ª××¨×™×š</th>
                            <th style="text-align: center;">×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for charge in charges %}
                        <tr>
                            <td style="font-weight: 500;">
                                {% if charge.get('charge_number') %}
                                <span style="color: #94a3b8; font-size: 0.75rem; font-weight: normal; margin-right: 8px; font-family: 'Heebo', monospace;">#{{ charge.charge_number }}</span>
                                {% endif %}
                                {{ charge.get('title', '') }}
                            </td>
                            <td style="text-align: center; color: var(--money); font-weight: bold; font-size: 1.05rem;">â‚ª{{ "{:,.0f}".format(charge.get('amount', 0)) }}</td>
                            <td class="editable-our-cost" 
                                data-client-id="{{ client.id }}" 
                                data-charge-id="{{ charge.get('id', '') }}"
                                style="text-align: center; color: #64748b; font-size: 0.95rem; cursor: pointer; padding: 8px; border-radius: 4px; transition: background 0.2s;"
                                onmouseover="this.style.background='#f0f0f0';"
                                onmouseout="if(!this.querySelector('input')) this.style.background='';"
                                onclick="editOurCost(this)">
                                {% if charge.get('our_cost', 0) > 0 %}
                                    â‚ª{{ "{:,.0f}".format(charge.get('our_cost', 0)) }}
                                {% else %}
                                    <span style="color: #94a3b8;">×œ×—×¥ ×œ×”×•×¡×¤×”</span>
                                {% endif %}
                            </td>
                            <td style="text-align: center; color: #64748b;">{{ charge.get('date', '') }}</td>
                            <td style="text-align: center;">
                                <form action="/delete_charge/{{ client.id }}/{{ charge.get('id', '') }}" method="POST" style="display: flex; justify-content: center; align-items: center; margin: 0;" onsubmit="return confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×—×™×•×‘?');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="btn btn-danger btn-small" style="background: white; border: 1px solid #e6e9ef; color: #043841; display: flex; align-items: center; justify-content: center; gap: 6px; box-shadow: none; margin: 0 auto;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#043841" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                        </svg>
                                        ××—×§
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr style="background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%); font-weight: bold;">
                            <td style="padding: 16px; font-size: 1.1rem;">×¡×”"×› ×—×™×•×‘×™× × ×•×¡×¤×™×:</td>
                            <td style="padding: 16px; text-align: center; color: var(--money); font-size: 1.3rem; font-weight: bold;">
                                {% set total_charges = 0 %}
                                {% for charge in charges %}
                                    {% set total_charges = total_charges + charge.get('amount', 0) %}
                                {% endfor %}
                                â‚ª{{ "{:,.0f}".format(total_charges) }}
                            </td>
                            <td style="padding: 16px; text-align: center; color: #64748b; font-size: 1.1rem;">
                                {% set total_our_cost = 0 %}
                                {% for charge in charges %}
                                    {% set total_our_cost = total_our_cost + charge.get('our_cost', 0) %}
                                {% endfor %}
                                {% if total_our_cost > 0 %}
                                    â‚ª{{ "{:,.0f}".format(total_our_cost) }}
                                {% else %}
                                    <span style="color: #94a3b8;">-</span>
                                {% endif %}
                            </td>
                            <td></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            {% else %}
            <div class="empty-state" style="padding: 30px;">
                <div style="font-weight: bold; color: #64748b;">××™×Ÿ ×—×™×•×‘×™× × ×•×¡×¤×™× ×¢×“×™×™×Ÿ</div>
            </div>
            {% endif %}
        </div>
        
        <!-- Documents Section -->
        <div class="documents-section">
            <h3 style="margin-bottom: 20px; color: #292f4c;">××¡××›×™×</h3>
            <form action="/upload_document/{{ client.id }}" method="POST" enctype="multipart/form-data" style="margin-bottom: 25px; display: flex; gap: 12px; align-items: flex-end;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="file" name="document" required style="padding: 8px 12px; background: white; border: 2px solid #e6e9ef; border-radius: 8px; font-family: 'Heebo', sans-serif;">
                <button type="submit" class="btn-black" style="padding: 8px 20px; white-space: nowrap;">×”×¢×œ×” ××¡××š</button>
            </form>
            
            {% if client.get('documents', []) %}
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px;">
                {% for doc in client.get('documents', []) %}
                <div style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); padding: 18px; border-radius: 12px; border: 1px solid #e6e9ef; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: var(--shadow-sm);">
                    <div style="flex: 1;">
                        <a href="/download_doc/{{ doc.get('file_path', '') }}" style="color: var(--primary); text-decoration: none; font-weight: bold; display: block; margin-bottom: 6px; transition: color 0.2s;">ğŸ“„ {{ doc.get('display_name', '××¡××š') }}</a>
                        <div style="font-size: 0.85rem; color: #64748b;">{{ doc.get('upload_date', '') }}</div>
                    </div>
                    {% if doc.get('id') %}
                    <button onclick="DocumentManager.delete('{{ client.id }}', '{{ doc.id }}', this)" style="background: none; border: none; cursor: pointer; font-size: 1.3rem; padding: 8px; transition: transform 0.2s; border-radius: 6px;" title="××—×§" onmouseover="this.style.transform='scale(1.2)'; this.style.background='#fee2e2';" onmouseout="this.style.transform='scale(1)'; this.style.background='none';">ğŸ—‘ï¸</button>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“„</div>
                <div style="font-weight: bold; color: #64748b;">××™×Ÿ ××¡××›×™× ×¢×“×™×™×Ÿ</div>
            </div>
            {% endif %}
        </div>
        
        <!-- Contacts Section -->
        <div class="documents-section">
            <h3 style="margin-bottom: 20px; color: #292f4c;">×™×¦×™×¨×ª ×§×©×¨</h3>
            <form action="/add_contact/{{ client.id }}" method="POST" style="margin-bottom: 25px; background: white; padding: 20px; border-radius: 12px; border: 2px solid #e6e9ef;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px; align-items: end;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #64748b; font-size: 0.9rem; font-weight: 600;">×©×:</label>
                        <input type="text" name="name" required style="width: 100%; padding: 8px 12px; border: 2px solid #e6e9ef; border-radius: 8px; font-family: 'Heebo', sans-serif;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #64748b; font-size: 0.9rem; font-weight: 600;">×˜×œ×¤×•×Ÿ:</label>
                        <input type="tel" name="phone" style="width: 100%; padding: 8px 12px; border: 2px solid #e6e9ef; border-radius: 8px; font-family: 'Heebo', sans-serif;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #64748b; font-size: 0.9rem; font-weight: 600;">××™×™×œ:</label>
                        <input type="email" name="email" style="width: 100%; padding: 8px 12px; border: 2px solid #e6e9ef; border-radius: 8px; font-family: 'Heebo', sans-serif;">
                    </div>
                    <button type="submit" class="btn-black" style="padding: 8px 20px; white-space: nowrap;">×”×•×¡×£ ××™×© ×§×©×¨</button>
                </div>
            </form>
            
            {% if client.get('contacts', []) %}
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                {% for contact in client.get('contacts', []) %}
                <div style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); padding: 18px; border-radius: 12px; border: 1px solid #e6e9ef; box-shadow: var(--shadow-sm);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                        <h4 style="margin: 0; color: #292f4c; font-size: 1.1rem; font-weight: bold;">{{ contact.get('name', '×œ×œ× ×©×') }}</h4>
                        <form action="/delete_contact/{{ client.id }}/{{ contact.get('id') }}" method="POST" style="display: inline;" onsubmit="return confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ××™×© ×”×§×©×¨?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" style="background: none; border: none; cursor: pointer; padding: 4px 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#fee2e2';" onmouseout="this.style.background='none';" title="××—×§">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#043841" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </form>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        {% if contact.get('phone') %}
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="color: #64748b; font-size: 0.9rem;">ğŸ“</span>
                            <a href="tel:{{ contact.get('phone') }}" style="color: var(--primary); text-decoration: none; font-size: 0.95rem;">{{ contact.get('phone') }}</a>
                        </div>
                        {% endif %}
                        {% if contact.get('email') %}
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="color: #64748b; font-size: 0.9rem;">âœ‰ï¸</span>
                            <a href="mailto:{{ contact.get('email') }}" style="color: var(--primary); text-decoration: none; font-size: 0.95rem;">{{ contact.get('email') }}</a>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ‘¤</div>
                <div style="font-weight: bold; color: #64748b;">××™×Ÿ ×× ×©×™ ×§×©×¨ ×¢×“×™×™×Ÿ</div>
            </div>
            {% endif %}
        </div>
        
        <!-- Activity History Section -->
        <div class="documents-section" style="margin-top: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #292f4c;">×”×™×¡×˜×•×¨×™×™×ª ×§×©×¨</h3>
                <div style="display: flex; gap: 10px;">
                    <button onclick="ActivityManager.showAddModal('call')" class="btn-black" style="padding: 8px 16px; font-size: 0.9rem;">ğŸ“ ×©×™×—×”</button>
                    <button onclick="ActivityManager.showAddModal('meeting')" class="btn-black" style="padding: 8px 16px; font-size: 0.9rem;">ğŸ“… ×¤×’×™×©×”</button>
                    <button onclick="ActivityManager.showAddModal('note')" class="btn-black" style="padding: 8px 16px; font-size: 0.9rem;">ğŸ“ ×”×¢×¨×”</button>
                </div>
            </div>
            
            {% if activity_logs %}
            <div class="activity-timeline" style="position: relative; padding-right: 30px;">
                {% for activity in activity_logs %}
                <div class="activity-item" style="background: white; padding: 18px; border-radius: 12px; margin-bottom: 15px; border-right: 4px solid {% if activity.activity_type == 'call' %}#25D366{% elif activity.activity_type == 'meeting' %}#667eea{% elif activity.activity_type == 'note' %}#f59e0b{% else %}#3d817a{% endif %}; box-shadow: var(--shadow-sm); position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                {% if activity.activity_type == 'call' %}
                                <span style="font-size: 1.2rem;">ğŸ“</span>
                                <strong style="color: #292f4c; font-size: 1rem;">×©×™×—×ª ×˜×œ×¤×•×Ÿ</strong>
                                {% elif activity.activity_type == 'meeting' %}
                                <span style="font-size: 1.2rem;">ğŸ“…</span>
                                <strong style="color: #292f4c; font-size: 1rem;">×¤×’×™×©×”</strong>
                                {% elif activity.activity_type == 'note' %}
                                <span style="font-size: 1.2rem;">ğŸ“</span>
                                <strong style="color: #292f4c; font-size: 1rem;">×”×¢×¨×”</strong>
                                {% else %}
                                <strong style="color: #292f4c; font-size: 1rem;">{{ activity.activity_type }}</strong>
                                {% endif %}
                                {% if activity.get('title') %}
                                <span style="color: #64748b; font-size: 0.95rem;">- {{ activity.title }}</span>
                                {% endif %}
                            </div>
                            {% if activity.get('content') %}
                            <div style="color: #64748b; font-size: 0.9rem; margin-bottom: 8px; line-height: 1.6;">{{ activity.content }}</div>
                            {% endif %}
                            {% if activity.get('duration') %}
                            <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 5px;">××©×š: {{ activity.duration }}</div>
                            {% endif %}
                            {% if activity.get('participants') %}
                            <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 5px;">××©×ª×ª×¤×™×: {{ activity.participants }}</div>
                            {% endif %}
                            {% if activity.get('follow_up_required') and activity.get('follow_up_date') %}
                            <div style="color: #f59e0b; font-size: 0.85rem; font-weight: bold; margin-top: 8px;">â° ×ª×–×›×•×¨×ª: {{ activity.follow_up_date }}</div>
                            {% endif %}
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 5px;">
                            <div style="color: #94a3b8; font-size: 0.8rem; white-space: nowrap;">
                                {% set activity_time = activity.timestamp.split('T') if 'T' in activity.timestamp else [activity.timestamp, ''] %}
                                {{ activity_time[0] }} {% if activity_time[1] %}{{ activity_time[1][:5] }}{% endif %}
                            </div>
                            <div style="color: #94a3b8; font-size: 0.75rem;">
                                {% set activity_user = sidebar_users.get(activity.user_id, {}) %}
                                {{ activity_user.get('name', activity.user_id) }}
                            </div>
                            <form action="/delete_activity/{{ activity.id }}" method="POST" style="display: inline;" onsubmit="return confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×¤×¢×™×œ×•×ª?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="hidden" name="client_id" value="{{ client.id }}">
                                <button type="submit" style="background: none; border: none; cursor: pointer; padding: 4px 8px; border-radius: 6px; transition: background 0.2s; margin-top: 5px;" onmouseover="this.style.background='#fee2e2';" onmouseout="this.style.background='none';" title="××—×§">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#043841" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“‹</div>
                <div style="font-weight: bold; color: #64748b;">××™×Ÿ ×¤×¢×™×œ×•×™×•×ª ×¨×©×•××•×ª ×¢×“×™×™×Ÿ</div>
                <div style="font-size: 0.9rem; color: #94a3b8; margin-top: 5px;">×”×•×¡×£ ×¤×¢×™×œ×•×ª ×¨××©×•× ×” ×‘×××¦×¢×•×ª ×”×›×¤×ª×•×¨×™× ×œ××¢×œ×”</div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Activity Modal -->
    <div id="activityModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
        <div style="background: white; padding: 30px; border-radius: 16px; max-width: 600px; width: 90%; box-shadow: 0 12px 48px rgba(0,0,0,0.25); direction: rtl;">
            <h3 id="activityModalTitle" style="margin: 0 0 20px 0; color: #292f4c; font-size: 1.5rem; font-weight: bold;"></h3>
            <form id="activityForm" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" name="activity_type" id="activityType">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #64748b; font-weight: 600;">× ×•×©×:</label>
                    <input type="text" name="title" style="width: 100%; padding: 10px; border: 2px solid #e6e9ef; border-radius: 8px; font-family: 'Heebo', sans-serif;">
                </div>
                <div id="durationField" style="margin-bottom: 15px; display: none;">
                    <label style="display: block; margin-bottom: 5px; color: #64748b; font-weight: 600;">××©×š ×–××Ÿ:</label>
                    <input type="text" name="duration" placeholder="×œ×“×•×’××”: 30 ×“×§×•×ª" style="width: 100%; padding: 10px; border: 2px solid #e6e9ef; border-radius: 8px; font-family: 'Heebo', sans-serif;">
                </div>
                <div id="participantsField" style="margin-bottom: 15px; display: none;">
                    <label style="display: block; margin-bottom: 5px; color: #64748b; font-weight: 600;">××©×ª×ª×¤×™×:</label>
                    <input type="text" name="participants" placeholder="×¨×©×•× ×©××•×ª ××©×ª×ª×¤×™×" style="width: 100%; padding: 10px; border: 2px solid #e6e9ef; border-radius: 8px; font-family: 'Heebo', sans-serif;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #64748b; font-weight: 600;">×ª×•×›×Ÿ/×”×¢×¨×•×ª:</label>
                    <textarea name="content" rows="4" style="width: 100%; padding: 10px; border: 2px solid #e6e9ef; border-radius: 8px; font-family: 'Heebo', sans-serif; resize: vertical;"></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                    <input type="checkbox" name="follow_up_required" id="followUpCheck" style="width: 20px; height: 20px; cursor: pointer;">
                    <label for="followUpCheck" style="color: #64748b; cursor: pointer;">×“×¨×•×©×” ×ª×–×›×•×¨×ª</label>
                    <input type="date" name="follow_up_date" id="followUpDate" style="padding: 8px; border: 2px solid #e6e9ef; border-radius: 8px; font-family: 'Heebo', sans-serif; display: none; margin-right: auto;">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" onclick="ActivityManager.closeModal()" style="padding: 10px 20px; border: 2px solid #e6e9ef; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; color: #64748b;">×‘×™×˜×•×œ</button>
                    <button type="submit" class="btn-black" style="padding: 10px 24px;">×©××•×¨</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Note Modal -->
    <div id="noteModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
        <div style="background: white; padding: 35px; border-radius: 16px; max-width: 600px; width: 90%; box-shadow: 0 12px 48px rgba(0,0,0,0.25); animation: modalSlideIn 0.3s ease-out; position: relative; max-height: 85vh; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #e6e9ef;">
                <h3 style="margin: 0; color: #292f4c; font-size: 1.5rem; font-weight: bold; display: flex; align-items: center; gap: 8px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#043841" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="background: white; padding: 4px; border-radius: 4px;">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    ×”×¢×¨×” ×œ××©×™××”
                </h3>
                <button onclick="TaskManager.closeNoteModal()" style="background: none; border: none; font-size: 1.8rem; cursor: pointer; color: #64748b; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='#f1f5f9'; this.style.color='#292f4c';" onmouseout="this.style.background='none'; this.style.color='#64748b';">Ã—</button>
            </div>
            <div style="flex: 1; overflow-y: auto; margin-bottom: 25px;">
                <div id="managerNoteContainer" style="display: none; margin-bottom: 20px; padding: 12px; background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%); border-right: 4px solid #f59e0b; border-radius: 8px;">
                    <div style="font-size: 0.75rem; font-weight: bold; color: #f59e0b; margin-bottom: 8px;">ğŸ‘” ×”×¢×¨×ª ×× ×”×œ:</div>
                    <div id="managerNoteContent" style="color: #292f4c; font-size: 0.95rem; line-height: 1.6;"></div>
                </div>
                <label style="display: block; margin-bottom: 10px; color: #64748b; font-size: 0.95rem; font-weight: 600;">×”×¢×¨×”:</label>
                <textarea id="noteModalText" placeholder="×”×–×Ÿ ×”×¢×¨×” ×›××Ÿ..." style="width: 100%; min-height: 150px; max-height: 400px; padding: 16px; border: 2px solid #e6e9ef; border-radius: 10px; font-family: 'Heebo', sans-serif; font-size: 1rem; resize: vertical; transition: all 0.3s; direction: rtl; line-height: 1.6;" onfocus="this.style.borderColor='#0073ea'; this.style.boxShadow='0 0 0 3px rgba(0,115,234,0.1)';" onblur="this.style.borderColor='#e6e9ef'; this.style.boxShadow='none';"></textarea>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 20px; border-top: 2px solid #e6e9ef;">
                <button onclick="TaskManager.closeNoteModal()" style="padding: 12px 24px; border: 2px solid #e6e9ef; background: white; border-radius: 10px; cursor: pointer; font-weight: 600; color: #64748b; transition: all 0.2s;" onmouseover="this.style.borderColor='#cbd5e1'; this.style.color='#292f4c';" onmouseout="this.style.borderColor='#e6e9ef'; this.style.color='#64748b';">×‘×™×˜×•×œ</button>
                <button id="noteModalDeleteBtn" onclick="TaskManager.deleteNoteFromModal()" style="padding: 12px 24px; background: #fee2e2; color: #d66b74; border: 2px solid #fecaca; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s; display: none; align-items: center; gap: 6px;" onmouseover="this.style.background='#d66b74'; this.style.color='white'; this.style.borderColor='#d66b74';" onmouseout="this.style.background='#fee2e2'; this.style.color='#d66b74'; this.style.borderColor='#fecaca';">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    ××—×§ ×”×¢×¨×”
                </button>
                <button onclick="TaskManager.saveNoteFromModal()" class="btn-black" style="padding: 12px 28px; font-weight: 600; border-radius: 10px; display: flex; align-items: center; gap: 6px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    ×©××•×¨ ×”×¢×¨×”
                </button>
            </div>
        </div>
    </div>
    
    <style>
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>
    
    <script src="{{ url_for('static', filename='client_page.js') }}"></script>
    <script>
        // Toggle project collapse/expand
        function toggleProject(projectCard) {
            projectCard.classList.toggle('collapsed');
        }
        
        function editOurCost(cell) {
            // ×‘×“×•×§ ×× ×›×‘×¨ ×‘×¢×¨×™×›×”
            if (cell.querySelector('input')) return;
            
            const currentValue = cell.textContent.trim();
            const numericValue = currentValue.replace(/[â‚ª,\s]/g, '').replace('×œ×—×¥ ×œ×”×•×¡×¤×”', '0');
            
            cell.style.background = 'white';
            cell.classList.add('editing');
            
            const input = document.createElement('input');
            input.type = 'number';
            input.step = '0.01';
            input.min = '0';
            input.value = numericValue || '0';
            input.style.width = '100px';
            input.style.textAlign = 'center';
            input.style.padding = '4px 8px';
            input.style.border = '2px solid #0073ea';
            input.style.borderRadius = '4px';
            input.style.fontSize = '0.95rem';
            
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            input.select();
            
            const save = async () => {
                const newValue = parseFloat(input.value) || 0;
                const clientId = cell.getAttribute('data-client-id');
                const chargeId = cell.getAttribute('data-charge-id');
                
                try {
                    const response = await fetch(`/update_charge_our_cost/${clientId}/${chargeId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ our_cost: newValue })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        // ×¨×¢× ×•×Ÿ ×”×“×£ ×œ×¢×“×›×•×Ÿ ×¡×”"×›
                        location.reload();
                    } else {
                        alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×¢×œ×•×ª ×”×¤× ×™××™×ª');
                        cell.innerHTML = currentValue;
                        cell.classList.remove('editing');
                    }
                } catch (error) {
                    console.error('Error updating our_cost:', error);
                    alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×¢×œ×•×ª ×”×¤× ×™××™×ª');
                    cell.innerHTML = currentValue;
                    cell.classList.remove('editing');
                }
            };
            
            input.onblur = save;
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    save();
                } else if (e.key === 'Escape') {
                    cell.classList.remove('editing');
                    cell.style.background = '';
                    cell.innerHTML = currentValue;
                }
            };
        }
        
        // ×¢×“×›×•×Ÿ ×¦×‘×¢×™ ×¡×˜×˜×•×¡ ××—×¨×™ ×˜×¢×™× ×ª ×”×“×£
        // ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×¤×¢×™×œ/×œ× ×¤×¢×™×œ ×©×œ ×œ×§×•×—
        async function toggleClientActive(checkbox) {
            const isActive = checkbox.checked;
            const clientId = '{{ client.id }}';
            
            try {
                const response = await fetch(`/toggle_client_active/${clientId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ active: isActive })
                });
                
                const data = await response.json();
                if (data.success) {
                    // ×× ×”×œ×§×•×— ×”×•×¢×‘×¨ ×œ××¨×›×™×•×Ÿ, ×”×¢×‘×¨ ×œ×“×£ ×”××¨×›×™×•×Ÿ
                    if (!isActive) {
                        if (confirm('×”×œ×§×•×— ×”×•×¢×‘×¨ ×œ××¨×›×™×•×Ÿ. ×”×× ×‘×¨×¦×•× ×š ×œ×¢×‘×•×¨ ×œ×“×£ ×”××¨×›×™×•×Ÿ?')) {
                            window.location.href = '/archive';
                        } else {
                            window.location.reload();
                        }
                    } else {
                        // ×× ×”×œ×§×•×— ×”×•×¤×¢×œ ××—×“×©, ×¨×¢× ×Ÿ ××ª ×”×“×£
                        window.location.reload();
                    }
                } else {
                    alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×”×œ×§×•×—: ' + (data.error || '×©×’×™××” ×œ× ×™×“×•×¢×”'));
                    checkbox.checked = !isActive; // ×”×—×–×¨ ×œ××¦×‘ ×”×§×•×“×
                }
            } catch (error) {
                console.error('Error toggling client active status:', error);
                alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×”×œ×§×•×—');
                checkbox.checked = !isActive; // ×”×—×–×¨ ×œ××¦×‘ ×”×§×•×“×
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            function updateStatusColors() {
                const statusSelects = document.querySelectorAll('.task-status-select');
                statusSelects.forEach(select => {
                    const currentStatus = select.value;
                    select.setAttribute('data-status', currentStatus);
                });
            }
            
            // ×¢×“×›×•×Ÿ ×¨××©×•× ×™
            updateStatusColors();
            
            // ×¢×“×›×•×Ÿ ×’× ×‘×¢×ª ×©×™× ×•×™ (event delegation)
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('task-status-select')) {
                    const newStatus = e.target.value;
                    e.target.setAttribute('data-status', newStatus);
                }
            });
        });
    </script>
    
    <script>
        // Activity Manager
        const ActivityManager = {
            showAddModal: function(type) {
                const modal = document.getElementById('activityModal');
                const form = document.getElementById('activityForm');
                const title = document.getElementById('activityModalTitle');
                const activityType = document.getElementById('activityType');
                const durationField = document.getElementById('durationField');
                const participantsField = document.getElementById('participantsField');
                const followUpCheck = document.getElementById('followUpCheck');
                const followUpDate = document.getElementById('followUpDate');
                
                activityType.value = type;
                form.action = `/add_activity/{{ client.id }}`;
                
                if (type === 'call') {
                    title.textContent = '×”×•×¡×£ ×©×™×—×ª ×˜×œ×¤×•×Ÿ';
                    durationField.style.display = 'block';
                    participantsField.style.display = 'none';
                } else if (type === 'meeting') {
                    title.textContent = '×”×•×¡×£ ×¤×’×™×©×”';
                    durationField.style.display = 'block';
                    participantsField.style.display = 'block';
                } else {
                    title.textContent = '×”×•×¡×£ ×”×¢×¨×”';
                    durationField.style.display = 'none';
                    participantsField.style.display = 'none';
                }
                
                modal.style.display = 'flex';
                
                // Follow-up checkbox handler
                followUpCheck.onchange = function() {
                    followUpDate.style.display = this.checked ? 'block' : 'none';
                    if (this.checked) {
                        followUpDate.required = true;
                    } else {
                        followUpDate.required = false;
                    }
                };
            },
            
            closeModal: function() {
                document.getElementById('activityModal').style.display = 'none';
                document.getElementById('activityForm').reset();
            }
        };
        
        // Close modal on outside click
        document.getElementById('activityModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                ActivityManager.closeModal();
            }
        });
    </script>
    
    {% include '_chat_widget.html' %}
</body>
</html>
