<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>×ª×¨×©×™× ×’×× ×˜ - {{ project.title }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='common_styles.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.css">
    <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
    <style>
        body { padding-right: 260px; }
        .gantt-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin: 30px;
            box-shadow: var(--shadow-md);
        }
        .gantt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .gantt-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .btn-view {
            padding: 8px 16px;
            border: 2px solid #e6e9ef;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Heebo', sans-serif;
            transition: all 0.2s;
        }
        .btn-view.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .gantt-chart {
            overflow-x: auto;
            min-height: 400px;
            background: #fafafa;
            border: 1px solid #e6e9ef;
            border-radius: 8px;
            padding: 20px;
            position: relative;
        }
        .gantt-container svg {
            width: 100%;
            height: auto;
        }
        .gantt-container .bar-wrapper {
            cursor: pointer;
        }
        .gantt-container .bar-wrapper:hover .bar {
            opacity: 0.8;
        }
        .task-details {
            margin-top: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <a href="/" class="sidebar-logo"><img src="{{ url_for('static', filename='Vatkin_Logo.jpg') }}"></a>
        <a href="/" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            ×“×©×‘×•×¨×“
        </a>
        <a href="/client/{{ client.id }}" class="nav-link active">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
            ×—×–×¨×” ×œ×œ×§×•×—
        </a>
        <a href="/all_clients" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            ×œ×•×— ×œ×§×•×—×•×ª
        </a>
        <a href="/finance" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
            ×›×¡×¤×™×
        </a>
        <a href="/events" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            ××™×¨×•×¢×™×
        </a>
        <a href="/suppliers" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
            ×¡×¤×§×™×
        </a>
        <a href="/quotes" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
            ×”×¦×¢×•×ª ××—×™×¨
        </a>
        <a href="/forms" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
            ×˜×¤×¡×™×
        </a>
        <a href="/admin/dashboard" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
            ×“×•×— ×× ×”×œ×™×
        </a>
        <div class="sidebar-user-area">
            <div class="sidebar-user-name">{{ current_user.name }}</div>
            <a href="/logout" class="sidebar-logout-link">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                ×”×ª× ×ª×§
            </a>
        </div>
    </div>

    <div class="gantt-container">
        <div class="gantt-header">
            <div>
                <h1 style="margin: 0; color: #292f4c; font-size: 1.8rem; font-weight: bold;">×ª×¨×©×™× ×’×× ×˜ - {{ project.title }}</h1>
                <p style="margin: 5px 0 0 0; color: #64748b; font-size: 0.95rem;">×œ×§×•×—: {{ client.name }}</p>
            </div>
            <a href="/client/{{ client.id }}" class="btn-black" style="padding: 12px 24px; text-decoration: none;">×—×–×¨×” ×œ×¤×¨×•×™×§×˜</a>
        </div>

        <div class="gantt-controls">
            <button class="btn-view active" data-view="Day">×™×•×</button>
            <button class="btn-view" data-view="Week">×©×‘×•×¢</button>
            <button class="btn-view" data-view="Month">×—×•×“×©</button>
        </div>

        <div id="gantt-chart" class="gantt-chart" style="min-height: 400px; background: #fafafa; border: 1px solid #e6e9ef; border-radius: 8px; padding: 20px;">
            {% if not tasks %}
            <div style="text-align: center; padding: 60px 20px; color: #64748b;">
                <div style="font-size: 3rem; margin-bottom: 20px;">ğŸ“Š</div>
                <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; color: #292f4c;">××™×Ÿ ××©×™××•×ª ×‘×¤×¨×•×™×§×˜</div>
                <div style="font-size: 0.95rem;">×”×•×¡×£ ××©×™××•×ª ×œ×¤×¨×•×™×§×˜ ×›×“×™ ×œ×¨××•×ª ××ª ×ª×¨×©×™× ×”×’×× ×˜</div>
                <a href="/client/{{ client.id }}" class="btn-black" style="display: inline-block; margin-top: 20px; padding: 12px 24px; text-decoration: none;">×—×–×¨×” ×œ×¤×¨×•×™×§×˜</a>
            </div>
            {% endif %}
        </div>
        
        <div class="gantt-info">
            <div style="font-weight: bold; color: #292f4c; margin-bottom: 10px; font-size: 1.1rem;">××™×“×¢ ×•×”× ×—×™×•×ª</div>
            <div style="color: #64748b; line-height: 1.8; font-size: 0.95rem;">
                <p>â€¢ ×œ×—×¥ ×•×’×¨×•×¨ ××ª ×”××©×™××•×ª ×›×“×™ ×œ×©× ×•×ª ××ª ×ª××¨×™×›×™ ×”×”×ª×—×œ×” ×•×”×¡×™×•×</p>
                <p>â€¢ ×œ×—×¥ ×¢×œ ××©×™××” ×›×“×™ ×œ×¨××•×ª ×¤×¨×˜×™× × ×•×¡×¤×™× ×•×œ×¢×¨×•×š ××•×ª×”</p>
                <p>â€¢ ×”×§×•×•×™× ×‘×™×Ÿ ×”××©×™××•×ª ××™×™×¦×’×™× ×ª×œ×•×™×•×ª - ××©×™××” ××—×ª ×ª×œ×•×™×” ×‘××—×¨×ª</p>
                <p>â€¢ ×¦×‘×¢×™ ×”××©×™××•×ª ××™×™×¦×’×™× ××ª ×¨××ª ×”×¢×“×™×¤×•×ª</p>
            </div>
            <div class="gantt-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #ef4444;"></div>
                    <span>×“×—×•×£</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f59e0b;"></div>
                    <span>×’×‘×•×”×”</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #3d817a;"></div>
                    <span>×‘×™× ×•× ×™×ª</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #94a3b8;"></div>
                    <span>× ××•×›×”</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // × ××ª×™×Ÿ ×©×›×œ ×”×“×£ × ×˜×¢×Ÿ ×œ×¤× ×™ ×©×™×¦×¨× ×• ××ª ×”×’×× ×˜
        window.addEventListener('load', function() {
            console.log('Gantt page fully loaded');
            const CLIENT_ID = '{{ client.id }}';
            const PROJECT_ID = '{{ project.id }}';
            
            // ×‘×“×™×§×” ×©×”×¡×¤×¨×™×™×” × ×˜×¢× ×”
            if (typeof Gantt === 'undefined') {
                console.error('Frappe Gantt library not loaded!');
                document.getElementById('gantt-chart').innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #ef4444;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">âš ï¸</div>
                        <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 10px;">×©×’×™××” ×‘×˜×¢×™× ×ª ×¡×¤×¨×™×™×ª ×”×’×× ×˜</div>
                        <div style="font-size: 0.95rem; margin-bottom: 20px;">×¡×¤×¨×™×™×ª Frappe Gantt ×œ× × ×˜×¢× ×”. ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜ ×•× ×¡×” ×œ×¨×¢× ×Ÿ ××ª ×”×“×£.</div>
                        <button onclick="location.reload()" class="btn-black" style="padding: 12px 24px; cursor: pointer; border: none;">×¨×¢× ×Ÿ ×“×£</button>
                    </div>
                `;
                return;
            }
            
            // ×”×›× ×ª × ×ª×•× ×™× ×œ×ª×¨×©×™× ×’×× ×˜
            const tasks = {{ tasks | tojson }};
            console.log('Tasks loaded:', tasks.length, tasks);
            
            if (!tasks || tasks.length === 0) {
                console.log('No tasks found for gantt chart');
                document.getElementById('gantt-chart').innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #64748b;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">ğŸ“Š</div>
                        <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; color: #292f4c;">××™×Ÿ ××©×™××•×ª ×‘×¤×¨×•×™×§×˜</div>
                        <div style="font-size: 0.95rem;">×”×•×¡×£ ××©×™××•×ª ×œ×¤×¨×•×™×§×˜ ×›×“×™ ×œ×¨××•×ª ××ª ×ª×¨×©×™× ×”×’×× ×˜</div>
                        <a href="/client/${CLIENT_ID}" class="btn-black" style="display: inline-block; margin-top: 20px; padding: 12px 24px; text-decoration: none;">×—×–×¨×” ×œ×¤×¨×•×™×§×˜</a>
                    </div>
                `;
                return;
            }
            // ×”×’×“×¨×ª ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×œ×¤× ×™ ×”×©×™××•×© ×‘×”×Ÿ
            function getPriorityClass(priority) {
                const classes = {
                    'urgent': 'gantt-bar-urgent',
                    'high': 'gantt-bar-high',
                    'medium': 'gantt-bar-medium',
                    'low': 'gantt-bar-low'
                };
                return classes[priority] || 'gantt-bar-medium';
            }
            
            function formatDate(date) {
                if (!date) return '';
                const d = new Date(date);
                return d.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' });
            }
            
            function formatDateForServer(date) {
                if (!date) return '';
                if (typeof date === 'string') {
                    return date.split('T')[0];
                }
                const d = new Date(date);
                return d.toISOString().split('T')[0];
            }
            
            function getPriorityLabel(priority) {
                const labels = {
                    'urgent': '×“×—×•×£',
                    'high': '×’×‘×•×”×”',
                    'medium': '×‘×™× ×•× ×™×ª',
                    'low': '× ××•×›×”'
                };
                return labels[priority] || '×‘×™× ×•× ×™×ª';
            }
            
            function showNotification(message, type) {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: ${type === 'success' ? '#14a675' : '#ef4444'};
                    color: white;
                    padding: 15px 25px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    font-family: 'Heebo', sans-serif;
                    font-weight: 600;
                `;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.3s';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
            
            const tasksMap = new Map(tasks.map(t => [t.id, t]));
            
            // ×¤×•× ×§×¦×™×” ×œ×”××¨×ª ×ª××¨×™×š ×œ×¤×•×¨××˜ YYYY-MM-DD
            function normalizeDate(dateInput) {
                if (!dateInput) return null;
                
                try {
                    let dateStr = dateInput;
                    
                    // ×× ×–×” ××—×¨×•×–×ª, × ×¡×” ×œ×”××™×¨
                    if (typeof dateStr === 'string') {
                        // ×”×¡×¨ T ×•×›×œ ××” ×©××—×¨×™×• (×–××Ÿ)
                        if (dateStr.includes('T')) {
                            dateStr = dateStr.split('T')[0];
                        }
                        
                        // ×‘×“×™×§×” ×©×–×” ×‘×¤×•×¨××˜ YYYY-MM-DD
                        const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
                        if (dateRegex.test(dateStr)) {
                            // ×•×™×“×•× ×©×–×” ×ª××¨×™×š ×ª×§×™×Ÿ
                            const dateObj = new Date(dateStr);
                            if (!isNaN(dateObj.getTime())) {
                                return dateStr;
                            }
                        }
                        
                        // × ×¡×” ×œ×”××™×¨ ×ª××¨×™×š ×‘×¤×•×¨××˜ ××—×¨
                        const dateObj = new Date(dateStr);
                        if (!isNaN(dateObj.getTime())) {
                            const year = dateObj.getFullYear();
                            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                            const day = String(dateObj.getDate()).padStart(2, '0');
                            return `${year}-${month}-${day}`;
                        }
                    } else if (dateInput instanceof Date) {
                        // ×× ×–×” ××•×‘×™×™×§×˜ Date
                        if (!isNaN(dateInput.getTime())) {
                            const year = dateInput.getFullYear();
                            const month = String(dateInput.getMonth() + 1).padStart(2, '0');
                            const day = String(dateInput.getDate()).padStart(2, '0');
                            return `${year}-${month}-${day}`;
                        }
                    }
                    
                    return null;
                } catch (e) {
                    console.error('Error normalizing date:', dateInput, e);
                    return null;
                }
            }
            
            const ganttTasks = tasks
                .filter(task => task && task.id) // ××¡× ×Ÿ ××©×™××•×ª ×œ× ×ª×§×™× ×•×ª
                .map(task => {
                    try {
                        // ×˜×™×¤×•×œ ×‘×ª××¨×™×š ×”×ª×—×œ×”
                        let start = normalizeDate(task.start_date || task.created_at);
                        if (!start) {
                            // ×× ××™×Ÿ ×ª××¨×™×š ×ª×§×™×Ÿ, × ×©×ª××© ×‘×ª××¨×™×š ×”×™×•×
                            start = normalizeDate(new Date());
                        }
                        
                        // ×˜×™×¤×•×œ ×‘×ª××¨×™×š ×¡×™×•×
                        let end = normalizeDate(task.deadline);
                        if (!end) {
                            // ×× ××™×Ÿ ×ª××¨×™×š ×¡×™×•×, × ×•×¡×™×£ 7 ×™××™× ××ª××¨×™×š ×”×”×ª×—×œ×”
                            const startDate = new Date(start);
                            startDate.setDate(startDate.getDate() + 7);
                            end = normalizeDate(startDate);
                        }
                        
                        // ×•×™×“×•× ×©×”×ª××¨×™×›×™× ×ª×§×™× ×™×
                        if (!start || !end) {
                            console.warn('Invalid dates for task:', task.id, {start, end});
                            const today = normalizeDate(new Date());
                            start = start || today;
                            end = end || today;
                        }
                        
                        // ×•×™×“×•× ×©-end ×œ× ×œ×¤× ×™ start
                        if (new Date(end) < new Date(start)) {
                            const startDate = new Date(start);
                            startDate.setDate(startDate.getDate() + 7);
                            end = normalizeDate(startDate);
                        }
                        
                        // ×˜×™×¤×•×œ ×‘-dependencies
                        let dependenciesStr = '';
                        if (task.dependencies) {
                            if (Array.isArray(task.dependencies)) {
                                dependenciesStr = task.dependencies.filter(d => d != null && d !== '').join(',');
                            } else if (typeof task.dependencies === 'string') {
                                dependenciesStr = task.dependencies;
                            }
                        }
                        
                        return {
                            id: String(task.id || Date.now() + Math.random()),
                            name: String(task.title || '×œ×œ× ×©×'),
                            start: start,
                            end: end,
                            progress: (task.progress != null) ? Math.max(0, Math.min(100, parseInt(task.progress) || 0)) : 0,
                            dependencies: dependenciesStr,
                            custom_class: getPriorityClass(task.priority || 'medium'),
                            _custom: {
                                task_id: String(task.id || Date.now() + Math.random()),
                                status: task.status || '×œ×‘×™×¦×•×¢',
                                priority: task.priority || 'medium',
                                assignee: task.assignee || ''
                            }
                        };
                    } catch (e) {
                        console.error('Error processing task:', task, e);
                        // ××—×–×™×¨ ××©×™××” ×‘×¨×™×¨×ª ××—×“×œ ×‘××§×¨×” ×©×œ ×©×’×™××”
                        const today = normalizeDate(new Date());
                        return {
                            id: String(task?.id || Date.now() + Math.random()),
                            name: String(task?.title || '××©×™××” ×¢× ×©×’×™××”'),
                            start: today,
                            end: today,
                            progress: 0,
                            dependencies: '',
                            custom_class: 'gantt-bar-medium',
                            _custom: {
                                task_id: String(task?.id || Date.now() + Math.random()),
                                status: '×œ×‘×™×¦×•×¢',
                                priority: 'medium',
                                assignee: ''
                            }
                        };
                    }
                })
                .filter(task => {
                    // ××¡× ×Ÿ ××©×™××•×ª ×¨×§ ×¢× ×ª××¨×™×›×™× ×ª×§×™× ×™× ×‘×¤×•×¨××˜ YYYY-MM-DD
                    if (!task || !task.start || !task.end) return false;
                    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
                    if (!dateRegex.test(task.start) || !dateRegex.test(task.end)) return false;
                    // ×•×™×“×•× ×©×”×ª××¨×™×š ×ª×§×™×Ÿ
                    const startDate = new Date(task.start);
                    const endDate = new Date(task.end);
                    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) return false;
                    return true;
                });
            
            console.log('Gantt tasks prepared:', ganttTasks);
            
            function updateDependentTasks(taskId, newDeadline) {
                // ×¢×“×›×Ÿ ×ª××¨×™×›×™ ××©×™××•×ª ×©×ª×œ×•×™×•×ª ×‘××©×™××” ×–×•
                if (!taskId || !newDeadline) {
                    return;
                }
                
                ganttTasks.forEach(gtask => {
                    if (!gtask || !gtask.dependencies) {
                        return;
                    }
                    
                    // dependencies ×™×›×•×œ ×œ×”×™×•×ª ××—×¨×•×–×ª ××•×¤×¨×“×ª ×‘×¤×¡×™×§×™× ××• ××¢×¨×š
                    let dependencies = [];
                    if (typeof gtask.dependencies === 'string' && gtask.dependencies !== '') {
                        dependencies = gtask.dependencies.split(',').map(d => d.trim()).filter(d => d !== '');
                    } else if (Array.isArray(gtask.dependencies)) {
                        dependencies = gtask.dependencies;
                    }
                    
                    if (dependencies.includes(taskId)) {
                        try {
                            const depTask = tasksMap.get(taskId);
                            const currentTask = tasksMap.get(gtask.id);
                            
                            if (currentTask && newDeadline) {
                                // ×—×©×‘ ×ª××¨×™×š ×™×¢×“ ×—×“×© ×¢×œ ×‘×¡×™×¡ ×”×ª×œ×•×ª
                                const estimatedHours = currentTask.estimated_hours || 8;
                                const estimatedDays = Math.max(1, Math.ceil(estimatedHours / 8));
                                const newEnd = new Date(newDeadline);
                                if (!isNaN(newEnd.getTime())) {
                                    newEnd.setDate(newEnd.getDate() + estimatedDays);
                                    gtask.end = formatDateForServer(newEnd);
                                    gtask._end = newEnd;
                                }
                            }
                        } catch (e) {
                            console.error('Error updating dependent task:', e);
                        }
                    }
                });
            }

            // ×™×¦×™×¨×ª ×ª×¨×©×™× ×’×× ×˜
            console.log('Creating Gantt chart with', ganttTasks.length, 'tasks');
            console.log('Gantt tasks data:', JSON.stringify(ganttTasks, null, 2));
            
            // ×‘×“×™×§×” ×©×™×© ××©×™××•×ª ×ª×§×™× ×•×ª
            if (ganttTasks.length === 0) {
                document.getElementById('gantt-chart').innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #64748b;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">ğŸ“Š</div>
                        <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; color: #292f4c;">××™×Ÿ ××©×™××•×ª ×ª×§×™× ×•×ª ×œ×¤×¨×•×™×§×˜</div>
                        <div style="font-size: 0.95rem;">×”×•×¡×£ ××©×™××•×ª ×œ×¤×¨×•×™×§×˜ ×›×“×™ ×œ×¨××•×ª ××ª ×ª×¨×©×™× ×”×’×× ×˜</div>
                        <a href="/client/${CLIENT_ID}" class="btn-black" style="display: inline-block; margin-top: 20px; padding: 12px 24px; text-decoration: none;">×—×–×¨×” ×œ×¤×¨×•×™×§×˜</a>
                    </div>
                `;
                return;
            }
            
            try {
                // ×‘×“×™×§×” ×©×”×¡×¤×¨×™×™×” × ×˜×¢× ×”
                if (typeof Gantt === 'undefined') {
                    throw new Error('×¡×¤×¨×™×™×ª Frappe Gantt ×œ× × ×˜×¢× ×”. ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜.');
                }
                
                // ×•×™×“×•× ×©×›×œ ×”××©×™××•×ª ×ª×§×™× ×•×ª ×œ×¤× ×™ ×™×¦×™×¨×ª ×”×’×× ×˜
                const validTasks = ganttTasks.filter(t => {
                    if (!t || !t.id || !t.name) return false;
                    
                    // ×‘×“×™×§×” ×©×”×ª××¨×™×›×™× ×‘×¤×•×¨××˜ YYYY-MM-DD
                    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
                    if (!t.start || !t.end) return false;
                    if (!dateRegex.test(t.start) || !dateRegex.test(t.end)) return false;
                    
                    // ×‘×“×™×§×” ×©×”×ª××¨×™×›×™× ×ª×§×™× ×™×
                    const startDate = new Date(t.start);
                    const endDate = new Date(t.end);
                    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) return false;
                    
                    // ×•×™×“×•× ×©-end ×œ× ×œ×¤× ×™ start
                    if (endDate < startDate) return false;
                    
                    return true;
                }).map(t => ({
                    ...t,
                    start: t.start,
                    end: t.end,
                    progress: Math.max(0, Math.min(100, t.progress || 0))
                }));
                
                if (validTasks.length === 0) {
                    throw new Error('××™×Ÿ ××©×™××•×ª ×ª×§×™× ×•×ª ×œ×”×¦×’×” - ×—×¡×¨×™× × ×ª×•× ×™× ×—×™×•× ×™×™× ××• ×ª××¨×™×›×™× ×œ× ×ª×§×™× ×™×');
                }
                
                console.log('Using', validTasks.length, 'valid tasks out of', ganttTasks.length);
                console.log('Sample task:', validTasks[0]);
                console.log('All valid tasks:', validTasks);
                
                // ×‘×“×™×§×” × ×•×¡×¤×ª - ×•×™×“×•× ×©×›×œ ×”×ª××¨×™×›×™× ×ª×§×™× ×™× ×•××™×•×©×¨×™×
                const finalTasks = validTasks.map(t => {
                    // ×•×™×“×•× ×©×”×ª××¨×™×›×™× ×‘×¤×•×¨××˜ YYYY-MM-DD ×•×©×”× ××—×¨×•×–×•×ª
                    let start = String(t.start || '').trim();
                    let end = String(t.end || '').trim();
                    
                    // ×× ×”×ª××¨×™×›×™× ×œ× ×‘×¤×•×¨××˜ ×”× ×›×•×Ÿ, × ××™×¨ ××•×ª×
                    if (!/^\d{4}-\d{2}-\d{2}$/.test(start)) {
                        const d = new Date(start);
                        if (!isNaN(d.getTime())) {
                            start = d.toISOString().split('T')[0];
                        } else {
                            start = new Date().toISOString().split('T')[0];
                        }
                    }
                    
                    if (!/^\d{4}-\d{2}-\d{2}$/.test(end)) {
                        const d = new Date(end);
                        if (!isNaN(d.getTime())) {
                            end = d.toISOString().split('T')[0];
                        } else {
                            const startDate = new Date(start);
                            startDate.setDate(startDate.getDate() + 7);
                            end = startDate.toISOString().split('T')[0];
                        }
                    }
                    
                    // ×•×™×“×•× ×©-end ×œ× ×œ×¤× ×™ start
                    const startDate = new Date(start);
                    const endDate = new Date(end);
                    if (endDate < startDate) {
                        endDate.setTime(startDate.getTime());
                        endDate.setDate(endDate.getDate() + 1);
                        end = endDate.toISOString().split('T')[0];
                    }
                    
                    return {
                        id: String(t.id),
                        name: String(t.name || '×œ×œ× ×©×'),
                        start: start,
                        end: end,
                        progress: Math.max(0, Math.min(100, parseInt(t.progress) || 0)),
                        dependencies: String(t.dependencies || ''),
                        custom_class: t.custom_class || 'gantt-bar-medium',
                        _custom: t._custom || {}
                    };
                }).filter(t => {
                    // ×‘×“×™×§×” ××—×¨×•× ×” - ×¨×§ ××©×™××•×ª ×¢× ×ª××¨×™×›×™× ×ª×§×™× ×™×
                    if (!t.start || !t.end) return false;
                    if (!/^\d{4}-\d{2}-\d{2}$/.test(t.start) || !/^\d{4}-\d{2}-\d{2}$/.test(t.end)) return false;
                    const startDate = new Date(t.start);
                    const endDate = new Date(t.end);
                    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) return false;
                    return true;
                });
                
                if (finalTasks.length === 0) {
                    throw new Error('××™×Ÿ ××©×™××•×ª ×ª×§×™× ×•×ª ×œ×”×¦×’×” ××—×¨×™ ×‘×“×™×§×•×ª ×¡×•×¤×™×•×ª');
                }
                
                console.log('Final tasks after normalization:', finalTasks);
                
                // ×‘×“×™×§×” ××—×¨×•× ×” ×œ×¤× ×™ ×™×¦×™×¨×ª ×”×’×× ×˜ - ×•×™×“×•× ×©×”×›×œ ×ª×§×™×Ÿ
                // ×‘× ×•×¡×£, × ×•×•×“× ×©-dependencies ××ª×™×™×—×¡×•×ª ×œ××©×™××•×ª ×§×™×™××•×ª
                const taskIds = new Set(finalTasks.map(t => String(t.id)));
                
                for (let i = 0; i < finalTasks.length; i++) {
                    const task = finalTasks[i];
                    
                    // ×‘×“×™×§×ª ×ª××¨×™×›×™×
                    if (!task.start || !task.end) {
                        console.error('Task missing dates:', task);
                        throw new Error(`××©×™××” ${i} ×—×¡×¨×™× ×ª××¨×™×›×™×`);
                    }
                    
                    const startDate = new Date(task.start);
                    const endDate = new Date(task.end);
                    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                        console.error('Task with invalid dates:', task);
                        throw new Error(`××©×™××” ${i} ×ª××¨×™×›×™× ×œ× ×ª×§×™× ×™×`);
                    }
                    
                    // ×•×™×“×•× ×©×”×ª××¨×™×›×™× ×‘×¤×•×¨××˜ YYYY-MM-DD
                    if (!/^\d{4}-\d{2}-\d{2}$/.test(task.start) || !/^\d{4}-\d{2}-\d{2}$/.test(task.end)) {
                        console.error('Task dates not in YYYY-MM-DD format:', task);
                        throw new Error(`××©×™××” ${i} ×ª××¨×™×›×™× ×œ× ×‘×¤×•×¨××˜ ×”× ×›×•×Ÿ`);
                    }
                    
                    // × ×™×§×•×™ dependencies ×©×œ× ×§×™×™××•×ª
                    if (task.dependencies && task.dependencies !== '') {
                        const deps = task.dependencies.split(',').map(d => d.trim()).filter(d => d !== '');
                        const validDeps = deps.filter(depId => taskIds.has(String(depId)));
                        if (validDeps.length !== deps.length) {
                            console.warn(`Task ${task.id} has invalid dependencies. Cleaning...`);
                            task.dependencies = validDeps.join(',');
                        }
                    }
                }
                
                console.log('All tasks validated successfully. Creating Gantt chart...');
                console.log('Tasks to render:', JSON.stringify(finalTasks, null, 2));
                
                // ×™×¦×™×¨×ª ×”×’×× ×˜ - ×”×¡×¨×ª language ×›×“×™ ×œ×× ×•×¢ ×‘×¢×™×•×ª ×¢× ×ª××¨×™×›×™×
                const gantt = new Gantt('#gantt-chart', finalTasks, {
                    view_mode: 'Month',
                    header_height: 50,
                    column_width: 30,
                    step: 24,
                    bar_height: 28,
                    bar_corner_radius: 4,
                    arrow_curve: 5,
                    padding: 18,
                    date_format: 'YYYY-MM-DD',
                    popup_trigger: 'click',
                    custom_popup_html: function(task) {
                        try {
                            if (!task || !task._custom || !task._custom.task_id) {
                                return '<div style="padding: 15px; direction: rtl;">×©×’×™××”: ××©×™××” ×œ× ×ª×§×™× ×”</div>';
                            }
                            
                            const taskData = tasksMap.get(task._custom.task_id);
                            const statusColors = {
                                '×œ×‘×™×¦×•×¢': '#bfc9f2',
                                '×”×•×¢×‘×¨ ×œ×¡×˜×•×“×™×•': '#f0d6bb',
                                '×”×•×¢×‘×¨ ×œ×“×™×’×™×˜×œ': '#2b585e',
                                '× ×©×œ×— ×œ×œ×§×•×—': '#043841',
                                '×”×•×©×œ×': '#14a675'
                            };
                            const statusColor = statusColors[taskData?.status] || '#8ab7ba';
                            
                            const taskStart = task._start || task.start || '';
                            const taskEnd = task._end || task.end || '';
                            const taskName = task.name || '×œ×œ× ×©×';
                            const taskProgress = task.progress || 0;
                            
                            return `
                                <div style="padding: 15px; direction: rtl; font-family: 'Heebo', sans-serif;">
                                    <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 10px; color: #292f4c;">${taskName}</div>
                                    <div style="margin-bottom: 8px;">
                                        <span style="font-weight: bold; color: #64748b;">×¡×˜×˜×•×¡:</span>
                                        <span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85rem; margin-right: 5px;">${taskData?.status || '×œ×‘×™×¦×•×¢'}</span>
                                    </div>
                                    ${taskData?.priority ? `
                                    <div style="margin-bottom: 8px;">
                                        <span style="font-weight: bold; color: #64748b;">×¢×“×™×¤×•×ª:</span>
                                        <span style="font-size: 0.9rem;">${getPriorityLabel(taskData.priority)}</span>
                                    </div>
                                    ` : ''}
                                    <div style="margin-bottom: 8px;">
                                        <span style="font-weight: bold; color: #64748b;">×”×ª×—×œ×”:</span>
                                        <span style="font-size: 0.9rem;">${formatDate(taskStart)}</span>
                                    </div>
                                    <div style="margin-bottom: 8px;">
                                        <span style="font-weight: bold; color: #64748b;">×¡×™×•×:</span>
                                        <span style="font-size: 0.9rem;">${formatDate(taskEnd)}</span>
                                    </div>
                                    ${taskProgress > 0 ? `
                                    <div style="margin-top: 10px;">
                                        <div style="background: #e6e9ef; border-radius: 4px; height: 8px; overflow: hidden;">
                                            <div style="background: #14a675; height: 100%; width: ${taskProgress}%; transition: width 0.3s;"></div>
                                        </div>
                                        <div style="text-align: center; margin-top: 5px; font-size: 0.85rem; color: #64748b;">${taskProgress}% ×”×•×©×œ×</div>
                                    </div>
                                    ` : ''}
                                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e6e9ef;">
                                        <a href="/client/${CLIENT_ID}#task-${task._custom.task_id}" style="color: var(--primary); text-decoration: none; font-size: 0.9rem; font-weight: bold;">â†’ ×¤×ª×— ××©×™××”</a>
                                    </div>
                                </div>
                            `;
                        } catch (e) {
                            console.error('Error in custom_popup_html:', e);
                            return '<div style="padding: 15px; direction: rtl;">×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×¨×˜×™ ×”××©×™××”</div>';
                        }
                    },
                    on_click: function (task) {
                        // ×œ×—×¥ ×¢×œ ××©×™××” - ××¢×‘×¨ ×œ×ª×™×§ ×”×œ×§×•×—
                        window.location.href = `/client/${CLIENT_ID}#task-${task._custom.task_id}`;
                    },
                    on_date_change: async function (task, start, end) {
                        // ×¢×“×›×•×Ÿ ×ª××¨×™×›×™× ×›×©×’×•×¨×¨×™×
                        try {
                            if (!task || !task._custom || !task._custom.task_id) {
                                console.error('Invalid task in on_date_change');
                                return;
                            }
                            
                            const taskId = task._custom.task_id;
                            const startDate = formatDateForServer(start);
                            const endDate = formatDateForServer(end);
                            
                            if (!startDate || !endDate) {
                                console.error('Invalid dates:', {start, end, startDate, endDate});
                                showNotification('×©×’×™××”: ×ª××¨×™×›×™× ×œ× ×ª×§×™× ×™×', 'error');
                                return;
                            }
                        
                            const response = await fetch(`/api/task/update_dates/${CLIENT_ID}/${PROJECT_ID}/${taskId}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    start_date: startDate,
                                    deadline: endDate
                                })
                            });
                            
                            const data = await response.json();
                            if (data.status === 'success') {
                                // ×¢×“×›×•×Ÿ ××•×¦×œ×— - ×¨×¢× ×•×Ÿ ×”×ª×œ×•×™×•×ª
                                updateDependentTasks(taskId, endDate);
                                showNotification('×ª××¨×™×›×™× ×¢×•×“×›× ×• ×‘×”×¦×œ×—×”', 'success');
                            } else {
                                showNotification('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×ª××¨×™×›×™×: ' + (data.error || '×©×’×™××” ×œ× ×™×“×•×¢×”'), 'error');
                                // ×—×–×•×¨ ×œ×ª××¨×™×›×™× ×”×§×•×“××™×
                                gantt.refresh(ganttTasks);
                            }
                        } catch (error) {
                            console.error('Error updating task dates:', error);
                            showNotification('×©×’×™××” ×‘×”×ª×§×©×¨×•×ª ×œ×©×¨×ª', 'error');
                            gantt.refresh(ganttTasks);
                        }
                    },
                    on_progress_change: async function (task, progress) {
                        // ×¢×“×›×•×Ÿ ××—×•×– ×”×©×œ××”
                        const taskId = task._custom.task_id;
                        // ×›××Ÿ × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×¢×“×›×•×Ÿ ×©×œ ××—×•×– ×”×©×œ××” ×œ×©×¨×ª
                    }
                });
                
                console.log('Gantt chart created successfully');
                
                // ×”×—×œ×¤×ª ×ª×¦×•×’×”
                document.querySelectorAll('.btn-view').forEach(btn => {
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('.btn-view').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        const view = this.dataset.view;
                        gantt.change_view_mode(view);
                    });
                });
                
                // ×”×•×¡×¤×ª CSS ×œ×ª×’×™×•×ª ×¢×“×™×¤×•×ª
                const style = document.createElement('style');
                style.textContent = `
                    .gantt-bar-urgent { fill: #ef4444 !important; }
                    .gantt-bar-high { fill: #f59e0b !important; }
                    .gantt-bar-medium { fill: #3d817a !important; }
                    .gantt-bar-low { fill: #94a3b8 !important; }
                    .gantt-container .bar-wrapper .bar-progress { fill: rgba(255,255,255,0.3) !important; }
                    .gantt-container svg { width: 100%; min-width: 800px; }
                `;
                document.head.appendChild(style);
            } catch (error) {
                console.error('Error creating Gantt chart:', error);
                document.getElementById('gantt-chart').innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #ef4444;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">âš ï¸</div>
                        <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 10px;">×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×¨×©×™× ×”×’×× ×˜</div>
                        <div style="font-size: 0.95rem; margin-bottom: 20px;">${error.message}</div>
                        <button onclick="location.reload()" class="btn-black" style="padding: 12px 24px; cursor: pointer; border: none;">×¨×¢× ×Ÿ ×“×£</button>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>

