<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>×›×¡×¤×™× | ×•×ª×§×™×Ÿ ×‘×•×˜×™×§</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='common_styles.css') }}">
    <style>
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .filters-container {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-box {
            padding: 12px 16px;
            border: 2px solid #e6e9ef;
            border-radius: 8px;
            font-size: 1rem;
            min-width: 250px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            right: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #e6e9ef;
            padding-bottom: 15px;
        }
        
        .close {
            font-size: 2rem;
            cursor: pointer;
            color: #999;
        }
        
        .close:hover {
            color: #333;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #28a745;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .charges-detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .charges-detail-table th,
        .charges-detail-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e6e9ef;
        }
        
        .charges-detail-table th {
            background: #043841; /* ×¦×‘×¢ ××—×™×“ ×œ×¨××©×™ ×˜×‘×œ××•×ª */
            font-weight: bold;
            color: white;
        }
        
        .charges-detail-table tr:hover {
            background: #f8fafc;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <a href="/" class="sidebar-logo"><img src="{{ url_for('static', filename='Vatkin_Logo.jpg') }}"></a>
        <a href="/" class="nav-link active">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            ×“×©×‘×•×¨×“
        </a>
        <div class="nav-item">
            <a href="/all_clients" class="nav-link active">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                ×œ×•×— ×œ×§×•×—×•×ª
            </a>
            <div class="users-dropdown">
                {% for uid, info in sidebar_users.items() %}
                <a href="/all_clients?user={{ uid }}" class="user-sub-link">â€¢ {{ info.name }}</a>
                {% endfor %}
            </div>
        </div>
        <a href="/finance" class="nav-link active">
            <svg class="nav-icon" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
            ×›×¡×¤×™×
        </a>
        <a href="/events" class="nav-link active">
            <svg class="nav-icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            ××™×¨×•×¢×™×
        </a>
        <a href="/suppliers" class="nav-link active">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
            ×¡×¤×§×™×
        </a>
        <a href="/quotes" class="nav-link active">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
            ×”×¦×¢×•×ª ××—×™×¨
        </a>
        <a href="/forms" class="nav-link active">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
            ×˜×¤×¡×™×
        </a>
        <a href="/admin/dashboard" class="nav-link active">
            <svg class="nav-icon" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
            ×“×•×— ×× ×”×œ×™×
        </a>
        {% if current_user.id == 'admin' %}
        <a href="/admin/users" class="nav-link active">
            <svg class="nav-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"></path></svg>
            × ×™×”×•×œ ×¦×•×•×ª
        </a>
        {% endif %}
        <div class="sidebar-user-area">
            <div class="sidebar-user-name">{{ current_user.name }}</div>
            <a href="/logout" class="sidebar-logout-link">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                ×”×ª× ×ª×§
            </a>
        </div>
    </div>
    <div class="container">
        <div style="margin-bottom: 30px;">
            <h1 style="margin: 0 0 30px 0; color: #292f4c; font-size: 2rem;">×¨×™×›×•×– ×›×¡×¤×™ ×œ×§×•×—×•×ª</h1>
            
            <!-- ×©× ×™ ×¨×™×‘×•×¢×™× ×’×“×•×œ×™× -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                <!-- ×¨×™×‘×•×¢ 1: ×—×™×•×‘×™× ×¤×ª×•×—×™× -->
                <div class="card" style="background: linear-gradient(135deg, #d66b74 0%, #c55a65 100%); color: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h2 style="margin: 0 0 20px 0; font-size: 1.5rem; font-weight: bold;">×›××” ×—×™×™×‘×™× ×œ× ×•?</h2>
                    <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 20px;">â‚ª{{ "{:,.0f}".format(total_open_charges) }}</div>
                    <button onclick="exportOpenCharges()" class="btn" style="background: white; color: #d66b74; font-weight: bold; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">ğŸ“Š ×”×•×¨×“ ×¤×™×¨×•×˜ ×œ××§×¡×œ</button>
                </div>
                
                <!-- ×¨×™×‘×•×¢ 2: ×”×›× ×¡×•×ª ×—×•×“×©×™×•×ª -->
                <div class="card" style="background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h2 style="margin: 0 0 20px 0; font-size: 1.5rem; font-weight: bold;">×›××” ×”×¨×•×•×—× ×• ×”×—×•×“×©?</h2>
                    <div style="font-size: 2.5rem; font-weight: bold;">â‚ª{{ "{:,.0f}".format(total_monthly_revenue) }}</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <!-- ×—×™×¤×•×© ×•×¡×™× ×•×Ÿ ×‘×ª×•×š ×”×˜×‘×œ×” -->
            <div style="padding: 20px; border-bottom: 2px solid #e6e9ef; margin-bottom: 20px;">
                <div class="filters-container" style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <input type="text" id="clientSearch" class="search-box" placeholder="ğŸ” ×—×¤×© ×œ×§×•×—..." onkeyup="searchClient()">
                    <label style="color: #64748b; font-weight: bold;">×¡×™× ×•×Ÿ ×œ×¤×™ ×—×•×“×©:</label>
                    <select id="monthFilter" onchange="filterTable()" style="padding: 10px; border: 2px solid #e6e9ef; border-radius: 8px; font-size: 1rem;">
                        <option value="">×›×œ ×”×—×•×“×©×™×</option>
                        <option value="01" {% if current_month == '01' %}selected{% endif %}>×™× ×•××¨</option>
                        <option value="02" {% if current_month == '02' %}selected{% endif %}>×¤×‘×¨×•××¨</option>
                        <option value="03" {% if current_month == '03' %}selected{% endif %}>××¨×¥</option>
                        <option value="04" {% if current_month == '04' %}selected{% endif %}>××¤×¨×™×œ</option>
                        <option value="05" {% if current_month == '05' %}selected{% endif %}>×××™</option>
                        <option value="06" {% if current_month == '06' %}selected{% endif %}>×™×•× ×™</option>
                        <option value="07" {% if current_month == '07' %}selected{% endif %}>×™×•×œ×™</option>
                        <option value="08" {% if current_month == '08' %}selected{% endif %}>××•×’×•×¡×˜</option>
                        <option value="09" {% if current_month == '09' %}selected{% endif %}>×¡×¤×˜××‘×¨</option>
                        <option value="10" {% if current_month == '10' %}selected{% endif %}>××•×§×˜×•×‘×¨</option>
                        <option value="11" {% if current_month == '11' %}selected{% endif %}>× ×•×‘××‘×¨</option>
                        <option value="12" {% if current_month == '12' %}selected{% endif %}>×“×¦××‘×¨</option>
                    </select>
                </div>
            </div>
            
            <table id="financeTable">
                <thead><tr><th>×œ×§×•×—</th><th>×¨×™×˜×™×™× ×¨</th><th>×—×™×•×‘×™× × ×•×¡×¤×™×</th><th>×—×™×•×‘×™× ×¤×ª×•×—×™×</th><th>×¡×”"×›</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
                <tbody>
                    {% for c in clients %}
                    <tr data-client-id="{{ c.id }}" data-client-name="{{ c.name|lower }}" data-charges='{{ c.get("extra_charges", [])|tojson|safe }}' data-retainer="{{ c.get('retainer', 0) }}">
                        <td><strong><a href="#" onclick="openChargesModal('{{ c.id }}', '{{ c.name|e }}'); return false;" style="color: var(--primary); text-decoration: none; cursor: pointer;">{{ c.name }}</a></strong></td>
                        <td>â‚ª{{ c.calculated_retainer }}</td>
                        <td class="charges-cell">â‚ª{{ c.calculated_extra }}</td>
                        <td class="open-charges-cell" style="color: #d66b74; font-weight: bold;">â‚ª{{ c.get('calculated_open_charges', 0) }}</td>
                        <td class="total-cell" style="color: var(--money); font-size: 1.1rem;"><strong>â‚ª{{ c.calculated_total }}</strong></td>
                        <td>
                            <button onclick="generateInvoice('{{ c.id }}')" class="btn btn-success btn-small">ğŸ“„ ×“×•"×— ×—×™×•×‘</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Modal ×œ×¤×™×¨×•×˜ ×—×™×•×‘×™× -->
        <div id="chargesModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2 id="modalClientName">×¤×™×¨×•×˜ ×—×™×•×‘×™×</h2>
                    <span class="close" onclick="closeChargesModal()" style="font-size: 2rem; cursor: pointer;">&times;</span>
                </div>
                <div id="chargesModalBody">
                    <!-- ×”×ª×•×›×Ÿ ×™×•×˜×¢×Ÿ ×“×¨×š JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ×”×’×“×¨×ª ×‘×¨×™×¨×ª ××—×“×œ ×œ×—×•×“×© ×”×§×œ× ×“×¨×™ ×”× ×•×›×—×™
        document.addEventListener('DOMContentLoaded', function() {
            const currentMonth = String(new Date().getMonth() + 1).padStart(2, '0'); // ×—×•×“×©×™× ×‘-JS ××ª×—×™×œ×™× ×-0
            const monthFilter = document.getElementById('monthFilter');
            if (monthFilter) {
                monthFilter.value = currentMonth;
                // ×”×¤×¢×œ ××ª ×”×¤×™×œ×˜×¨ ×›×“×™ ×œ×”×¦×™×’ ×¨×§ ××ª ×”× ×ª×•× ×™× ×©×œ ×”×—×•×“×© ×”× ×•×›×—×™
                filterTable();
            }
        });
        
        function searchClient() {
            const searchTerm = document.getElementById('clientSearch').value.toLowerCase().trim();
            filterTable();
        }
        
        function filterByMonth() {
            filterTable();
        }
        
        function filterTable() {
            const selectedMonth = document.getElementById('monthFilter').value;
            const searchTerm = document.getElementById('clientSearch').value.toLowerCase().trim();
            const rows = document.querySelectorAll('#financeTable tbody tr');
            
            rows.forEach(row => {
                const clientName = row.getAttribute('data-client-name') || '';
                const charges = JSON.parse(row.getAttribute('data-charges') || '[]');
                
                // Filter by search term
                let matchesSearch = !searchTerm || clientName.includes(searchTerm);
                
                // Filter by month
                let matchesMonth = true;
                if (selectedMonth) {
                    let hasChargeInMonth = false;
                    charges.forEach(charge => {
                        const chargeDate = charge.date || '';
                        const dateParts = chargeDate.split('/');
                        if (dateParts.length >= 2) {
                            const month = dateParts[1].padStart(2, '0');
                            if (month === selectedMonth) {
                                hasChargeInMonth = true;
                            }
                        }
                    });
                    matchesMonth = hasChargeInMonth || charges.length === 0;
                }
                
                // Show row if matches both filters
                if (matchesSearch && matchesMonth) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function generateInvoice(clientId) {
            const selectedMonth = document.getElementById('monthFilter').value;
            let url = '/generate_invoice/' + encodeURIComponent(clientId);
            if (selectedMonth) {
                url += '?month=' + encodeURIComponent(selectedMonth);
            }
            window.location.href = url;
        }
        
        function exportOpenCharges() {
            window.location.href = '/export_open_charges';
        }
        
        function parseDate(dateStr) {
            // ×”××¨×ª ×ª××¨×™×š ×‘×¤×•×¨××˜ dd/mm/yy ×œ-Date object
            if (!dateStr) return new Date(0);
            const parts = dateStr.split('/');
            if (parts.length < 3) return new Date(0);
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1; // ×—×•×“×©×™× ×‘-JS ××ª×—×™×œ×™× ×-0
            let year = parseInt(parts[2], 10);
            // ×× ×”×©× ×” ×”×™× 2 ×¡×¤×¨×•×ª, ×”×•×¡×£ 2000
            if (year < 100) {
                year += 2000;
            }
            return new Date(year, month, day);
        }
        
        function openChargesModal(clientId, clientName) {
            // ××¦×™××ª ×”×œ×§×•×— ×‘×˜×‘×œ×”
            const row = document.querySelector(`tr[data-client-id="${clientId}"]`);
            if (!row) return;
            
            const chargesJson = row.getAttribute('data-charges');
            let charges = JSON.parse(chargesJson || '[]');
            
            // ××™×•×Ÿ: ×§×•×“× ×—×™×•×‘×™× ×©×œ× ×”×•×©×œ××•, ××—×¨ ×›×š ×”×•×©×œ××•
            // ×‘×ª×•×š ×›×œ ×§×‘×•×¦×” - ××™×•×Ÿ ×œ×¤×™ ×ª××¨×™×š (×”×—×“×© ×‘×™×•×ª×¨ ×¨××©×•×Ÿ)
            charges.sort((a, b) => {
                const completedA = a.completed || false;
                const completedB = b.completed || false;
                
                // ×× ××—×“ ×”×•×©×œ× ×•×”×©× ×™ ×œ× - ××™ ×©×œ× ×”×•×©×œ× ×§×•×“×
                if (completedA !== completedB) {
                    return completedA ? 1 : -1; // ×œ× ×”×•×©×œ× (false) ×§×•×“×
                }
                
                // ×× ×©× ×™×”× ×‘××•×ª×• ×¡×˜×˜×•×¡ - ××™×™×Ÿ ×œ×¤×™ ×ª××¨×™×š (×™×•×¨×“)
                const dateA = parseDate(a.date || '');
                const dateB = parseDate(b.date || '');
                return dateB - dateA; // ×™×•×¨×“ - ×”×—×“×© ×‘×™×•×ª×¨ ×¨××©×•×Ÿ
            });
            
            // ×¢×“×›×•×Ÿ ×›×•×ª×¨×ª
            document.getElementById('modalClientName').textContent = `×¤×™×¨×•×˜ ×—×™×•×‘×™× - ${clientName}`;
            
            // ×‘× ×™×™×ª ×ª×•×›×Ÿ ×”×˜×‘×œ×”
            let html = '<table class="charges-detail-table">';
            html += '<thead><tr><th>×ª××¨×™×š</th><th>×ª×™××•×¨</th><th>×¡×›×•× ×œ×—×™×•×‘</th><th>×¢×œ×•×ª ×¤× ×™××™×ª</th><th>×—×™×•×‘ ×©×”×•×©×œ×</th></tr></thead>';
            html += '<tbody>';
            
            if (charges.length === 0) {
                html += '<tr><td colspan="5" style="text-align: center; color: #999; padding: 30px;">××™×Ÿ ×—×™×•×‘×™×</td></tr>';
            } else {
                charges.forEach(charge => {
                    const chargeId = charge.id || '';
                    const date = charge.date || '';
                    const title = charge.title || '';
                    const amount = charge.amount || 0;
                    const ourCost = charge.our_cost || 0;
                    const completed = charge.completed || false;
                    
                    html += '<tr>';
                    html += `<td>${date}</td>`;
                    const chargeNumber = charge.charge_number ? `<span style="color: #94a3b8; font-size: 0.75rem; font-weight: normal; margin-right: 8px; font-family: 'Heebo', monospace;">#${charge.charge_number}</span>` : '';
                    html += `<td>${chargeNumber}${title}</td>`;
                    html += `<td>â‚ª${amount.toLocaleString()}</td>`;
                    html += `<td class="editable-our-cost-modal" data-client-id="${clientId}" data-charge-id="${chargeId}" style="color: #64748b; cursor: pointer; padding: 8px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f0f0f0';" onmouseout="if(!this.querySelector('input')) this.style.background='';" onclick="editOurCostModal(this)">${ourCost > 0 ? 'â‚ª' + ourCost.toLocaleString() : '<span style="color: #94a3b8;">×œ×—×¥ ×œ×”×•×¡×¤×”</span>'}</td>`;
                    html += '<td>';
                    html += `<label class="switch">`;
                    html += `<input type="checkbox" ${completed ? 'checked' : ''} onchange="toggleChargeStatus('${clientId}', '${chargeId}', this.checked)">`;
                    html += `<span class="slider"></span>`;
                    html += `</label>`;
                    html += '</td>';
                    html += '</tr>';
                });
            }
            
            html += '</tbody></table>';
            document.getElementById('chargesModalBody').innerHTML = html;
            
            // ×”×¦×’×ª ×”-modal
            document.getElementById('chargesModal').style.display = 'block';
        }
        
        function closeChargesModal() {
            document.getElementById('chargesModal').style.display = 'none';
        }
        
        function toggleChargeStatus(clientId, chargeId, completed) {
            fetch(`/toggle_charge_status/${clientId}/${chargeId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // ×¨×¢× ×•×Ÿ ×”×“×£ ×œ×¢×“×›×•×Ÿ ×”×¢××•×“×” "×—×™×•×‘×™× ×¤×ª×•×—×™×"
                    location.reload();
                } else {
                    alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×¡×˜×˜×•×¡');
                    // ×”×—×–×¨ ××ª ×”-switch ×œ××¦×‘ ×”×§×•×“×
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×¡×˜×˜×•×¡');
                location.reload();
            });
        }
        
        // ×¡×’×™×¨×ª modal ×‘×œ×—×™×¦×” ××—×•×¥ ×œ×•
        window.onclick = function(event) {
            const modal = document.getElementById('chargesModal');
            if (event.target == modal) {
                closeChargesModal();
            }
        }
        
        function editOurCostModal(cell) {
            // ×‘×“×•×§ ×× ×›×‘×¨ ×‘×¢×¨×™×›×”
            if (cell.querySelector('input')) return;
            
            const currentValue = cell.textContent.trim();
            const numericValue = currentValue.replace(/[â‚ª,\s]/g, '').replace('×œ×—×¥ ×œ×”×•×¡×¤×”', '0');
            
            cell.style.background = 'white';
            cell.classList.add('editing');
            
            const input = document.createElement('input');
            input.type = 'number';
            input.step = '0.01';
            input.min = '0';
            input.value = numericValue || '0';
            input.style.width = '100px';
            input.style.textAlign = 'center';
            input.style.padding = '4px 8px';
            input.style.border = '2px solid #0073ea';
            input.style.borderRadius = '4px';
            input.style.fontSize = '0.95rem';
            
            const originalHTML = cell.innerHTML;
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            input.select();
            
            const save = async () => {
                const newValue = parseFloat(input.value) || 0;
                const clientId = cell.getAttribute('data-client-id');
                const chargeId = cell.getAttribute('data-charge-id');
                
                try {
                    const response = await fetch(`/update_charge_our_cost/${clientId}/${chargeId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ our_cost: newValue })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        // ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×”
                        cell.classList.remove('editing');
                        cell.style.background = '';
                        if (newValue > 0) {
                            cell.textContent = `â‚ª${newValue.toLocaleString('he-IL', {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
                        } else {
                            cell.innerHTML = '<span style="color: #94a3b8;">×œ×—×¥ ×œ×”×•×¡×¤×”</span>';
                        }
                        // ×¨×¢× ×•×Ÿ ×”×“×£ ×œ×¢×“×›×•×Ÿ ×”× ×ª×•× ×™× ×‘×˜×‘×œ×” ×”×¨××©×™×ª
                        location.reload();
                    } else {
                        alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×¢×œ×•×ª ×”×¤× ×™××™×ª');
                        cell.innerHTML = originalHTML;
                        cell.classList.remove('editing');
                    }
                } catch (error) {
                    console.error('Error updating our_cost:', error);
                    alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×¢×œ×•×ª ×”×¤× ×™××™×ª');
                    cell.innerHTML = originalHTML;
                    cell.classList.remove('editing');
                }
            };
            
            input.onblur = save;
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    save();
                } else if (e.key === 'Escape') {
                    cell.classList.remove('editing');
                    cell.style.background = '';
                    cell.innerHTML = originalHTML;
                }
            };
        }
    </script>
    {% include '_chat_widget.html' %}
</body>
</html>